<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>æˆ‘çš„è¨‚æˆ¿ç´€éŒ„ - é–å¯¬é–å»£</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body { font-family:"Noto Sans TC","Microsoft JhengHei"; margin:0; background:#f5f5f5; }
  header { background:#06c755; color:#fff; padding:16px; font-size:22px; font-weight:900; text-align:center; }
  .container { max-width:560px; margin:0 auto; padding:16px; }
  .card {
    background:#fff; border-radius:16px; padding:16px;
    margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,0.08);
  }
  .title { font-size:16px; font-weight:700; margin-bottom:8px; }
  .row { margin-bottom:4px; font-size:14px; }
  .status { margin-top:6px; font-weight:700; }
  .status.ok { color:#06c755; }
  .status.wait { color:#f57c00; }
  .status.cancel { color:#d32f2f; }
</style>
</head>

<body>

<header>æˆ‘çš„è¨‚æˆ¿ç´€éŒ„</header>

<div class="container">
  <div id="list">è®€å–ä¸­â€¦</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxAhWFD3rLv2O1RSnmEA3EJjXIK5vFKja4IHGtL8EW3q-6ZD77K1Emc_ryFAK1fOZKA/exec";
const LIFF_ID = "2008409020-Way8kzM7";

// é˜² XSS encode
function esc(s) {
  if (!s) return "";
  return String(s)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

document.addEventListener("DOMContentLoaded", init);

async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });

    // è‹¥å°šæœªç™»å…¥ â†’ é€²è¡Œç™»å…¥ï¼ˆåŒ…å« redirectï¼‰
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: window.location.href });
      return;
    }

    // LIFF redirect å›ä¾†å¾Œï¼Œç¢ºä¿ context æ­£å¸¸
    if (!liff.isInClient() && !liff.getContext()) {
      console.log("å°šæœªæº–å‚™å¥½");
      return;
    }

    const profile = await liff.getProfile();
    const uid = profile.userId;
    console.log("UID:", uid);

    loadBookings(uid);

  } catch (err) {
    console.error("LIFF åˆå§‹åŒ–å¤±æ•—ï¼š", err);

    // è‹¥ token è¢«æ’¤éŠ· â†’ å¼·åˆ¶é‡æ–°ç™»å…¥
    if (String(err).includes("revoked")) {
      liff.logout();
      setTimeout(() => liff.login(), 400);
      return;
    }

    document.getElementById("list").textContent =
      "LIFF åˆå§‹åŒ–å¤±æ•—ï¼š" + err;
  }
}

async function loadBookings(uid) {
  const listEl = document.getElementById("list");

  try {
    const url = `${API_URL}?action=getUserBookings&uid=${uid}&ts=${Date.now()}`;
    console.log("å‘¼å« APIï¼š", url);

    const res = await fetch(url);
    const json = await res.json();

    console.log("API å›å‚³å…§å®¹ï¼š", json);

    if (!json.success) {
      listEl.textContent = "API éŒ¯èª¤ï¼š" + json.error;
      return;
    }

    const items = json.bookings;

    if (!items || items.length === 0) {
      listEl.textContent = "ç›®å‰æ²’æœ‰è¨‚æˆ¿ç´€éŒ„ã€‚";
      return;
    }

    // ğŸŸ¢ æ¸²æŸ“è¨‚å–®åˆ—è¡¨ï¼ˆä½ åŸæœ¬æ¼æ‰ï¼‰
    listEl.innerHTML = items.map(b => `
      <div class="card">
        <div class="title">è¨‚å–®ç·¨è™Ÿï¼š${esc(b.id)}</div>
        <div class="row">å…¥ä½æ—¥æœŸï¼š${esc(b.date)}</div>
        <div class="row">ä½å®¿å¤©æ•¸ï¼š${esc(b.nights)} æ™š</div>
        <div class="row">é¤¨åˆ¥ï¼š${esc(b.house)}</div>
        <div class="row">äººæ•¸ï¼šå¤§äºº ${esc(b.adult)} / å°å­© ${esc(b.child)}</div>
        <div class="row">å¯µç‰©ï¼š${esc(b.pet)}</div>
        <div class="row">å‚™è¨»ï¼š${esc(b.note || "â€”")}</div>
        <div class="status ${statusColor(b.status)}">ç‹€æ…‹ï¼š${esc(b.status)}</div>
        <div class="status">æ”¶æ¬¾ï¼š${esc(b.payment)}</div>
      </div>
    `).join("");

  } catch (err) {
    listEl.textContent = "è®€å–å¤±æ•—ï¼š" + err;
    console.error("API ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
  }
}

function statusColor(s) {
  if (!s) return "wait";
  s = s.trim();
  if (["å·²è¨‚æˆ¿", "å·²å…¥ä½", "å®Œæˆ"].includes(s)) return "ok";
  if (["å¾…ç¢ºèª", "è™•ç†ä¸­"].includes(s)) return "wait";
  if (["å·²å–æ¶ˆ", "å–æ¶ˆ"].includes(s)) return "cancel";
  return "wait";
}
</script>

</body>
</html>

