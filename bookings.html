<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>我的訂房紀錄 - 靖寬靖廣</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body { font-family:"Noto Sans TC","Microsoft JhengHei"; margin:0; background:#f5f5f5; }
  header { background:#06c755; color:#fff; padding:16px; font-size:22px; font-weight:900; text-align:center; }
  .container { max-width:560px; margin:0 auto; padding:16px; }
  .card {
    background:#fff; border-radius:16px; padding:16px;
    margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,0.08);
  }
  .title { font-size:16px; font-weight:700; margin-bottom:8px; }
  .row { margin-bottom:4px; font-size:14px; }
  .status { margin-top:6px; font-weight:700; }
  .status.ok { color:#06c755; }
  .status.wait { color:#f57c00; }
  .status.cancel { color:#d32f2f; }
</style>
</head>

<body>

<header>我的訂房紀錄</header>

<div class="container">
  <div id="list">讀取中…</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwyDvx82gKgUUcyP-Ke7KJw1wVA2thbiGjhb0IO1-NbEUO5CqnXaz--SPSKEYUUB5tj/exec";
const LIFF_ID = "2008409020-k4Oy7Y0D";

// --- 安全轉義，避免 XSS ---
function esc(s) {
  if (!s) return "";
  return String(s)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

document.addEventListener("DOMContentLoaded", init);

async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });

    // 若未登入 → 自動登入
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    const uid = profile.userId;

    loadBookings(uid);

  } catch (err) {
    document.getElementById("list").textContent =
      "LIFF 初始化失敗：" + err;
  }
}

async function loadBookings(uid) {
  const listEl = document.getElementById("list");

  try {
    const res = await fetch(`${API_URL}?action=getUserBookings&uid=${uid}&ts=${Date.now()}`);
    const json = await res.json();

    if (!json.success) {
      listEl.textContent = "讀取失敗：" + json.error;
      return;
    }

    const items = json.bookings;

    if (!items || items.length === 0) {
      listEl.textContent = "目前沒有訂房紀錄。";
      return;
    }

    listEl.innerHTML = items.map(b => `
      <div class="card">
        <div class="title">訂單編號：${esc(b.id)}</div>
        <div class="row">入住日期：${esc(b.date)}</div>
        <div class="row">住宿天數：${esc(b.nights)} 晚</div>
        <div class="row">館別：${esc(b.house)}</div>
        <div class="row">人數：大人 ${esc(b.adult)} / 小孩 ${esc(b.child)}</div>
        <div class="row">寵物：${esc(b.pet)}</div>
        <div class="row">備註：${esc(b.note || "—")}</div>
        <div class="status ${statusColor(b.status)}">狀態：${esc(b.status)}</div>
        <div class="status">收款：${esc(b.payment)}</div>
      </div>
    `).join("");

  } catch (err) {
    listEl.textContent = "無法連線到伺服器，請稍後再試。";
  }
}

function statusColor(s) {
  if (!s) return "wait";

  s = s.trim();

  if (["已訂房", "已入住", "已完成", "完成"].includes(s)) return "ok";
  if (["待確認", "處理中"].includes(s)) return "wait";
  if (["已取消", "取消"].includes(s)) return "cancel";

  return "wait"; // default
}
</script>

</body>
</html>
