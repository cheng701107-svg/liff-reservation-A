<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>我的訂房紀錄</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body { font-family:"Noto Sans TC","Microsoft JhengHei"; margin:0; background:#f5f5f5; }
  header { background:#06c755; color:#fff; padding:16px; font-size:22px; font-weight:900; text-align:center; }
  .container { max-width:560px; margin:0 auto; padding:16px; }
  .card {
    background:#fff; border-radius:16px; padding:16px;
    margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,0.08);
  }
  .title { font-size:16px; font-weight:700; margin-bottom:8px; }
  .row { margin-bottom:4px; font-size:14px; }
  .status { margin-top:6px; font-weight:700; }
  .ok { color:#06c755; }
  .wait { color:#f57c00; }
  .cancel { color:#d32f2f; }
</style>
</head>

<body>
<header>我的訂房紀錄</header>

<div class="container">
  <div id="list">讀取中…</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxAhWFD3rLv2O1RSnmEA3EJjXIK5vFKja4IHGtL8EW3q-6ZD77K1Emc_ryFAK1fOZKA/exec";
const LIFF_ID = "2008409020-EqyQao4p";

/* ---------------------------------------------------
  安全輸出（避免 XSS）
--------------------------------------------------- */
function esc(s) {
  return String(s || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

/* ---------------------------------------------------
  狀態顏色
--------------------------------------------------- */
function statusColor(s) {
  s = (s || "").trim();
  if (["已訂房","已入住","完成","已確認"].includes(s)) return "ok";
  if (["待確認","處理中"].includes(s)) return "wait";
  if (["取消","已取消"].includes(s)) return "cancel";
  return "wait";
}

/* ---------------------------------------------------
  LIFF 初始化（更安全）
--------------------------------------------------- */
document.addEventListener("DOMContentLoaded", init);

async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });

    // 若未登入 → 立即重新導向登入
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: window.location.href });
      return;
    }

    // 取得用戶資料
    const profile = await liff.getProfile();
    const uid = profile.userId;

    loadBookings(uid);

  } catch (err) {
    console.error("LIFF 初始化失敗：", err);
    document.getElementById("list").textContent =
      "⚠ 無法初始化 LIFF，請重新嘗試或從 LINE 開啟。";
  }
}

/* ---------------------------------------------------
  取得訂單
--------------------------------------------------- */
async function loadBookings(uid) {
  const listEl = document.getElementById("list");

  try {
    const url = `${API_URL}?action=getUserBookings&uid=${uid}&ts=${Date.now()}`;
    const res = await fetch(url);
    const json = await res.json();

    if (!json.success) {
      listEl.textContent = "API 錯誤：" + json.error;
      return;
    }

    const items = json.bookings;
    if (!items || items.length === 0) {
      listEl.textContent = "目前沒有訂房紀錄。";
      return;
    }

    // 渲染訂單
    listEl.innerHTML = items.map(b => `
      <div class="card">
        <div class="title">訂單編號：${esc(b.id)}</div>
        <div class="row">入住日期：${esc(b.date)}</div>
        <div class="row">住宿天數：${esc(b.nights)} 晚</div>
        <div class="row">館別：${esc(b.house)}</div>
        <div class="row">人數：大人 ${esc(b.adult)} / 小孩 ${esc(b.child)}</div>
        <div class="row">寵物：${esc(b.pet || "無")}</div>
        <div class="row">備註：${esc(b.note || "無")}</div>

        <div class="row status ${statusColor(b.status)}">
          狀態：${esc(b.status)}
        </div>

        <div class="row" style="font-weight:700;">
          收款：${esc(b.payment)}
        </div>

      </div>
    `).join("");

  } catch (err) {
    console.error("API 發生錯誤：", err);
    listEl.textContent = "讀取失敗：" + err;
  }
}
</script>

</body>
</html>
