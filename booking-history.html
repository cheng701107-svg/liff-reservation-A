<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>預訂記錄</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body {
    font-family: Arial, "Microsoft JhengHei", sans-serif;
    background: #f2f2f2;
    margin: 0;
    padding: 0;
  }

  header {
    background: #06c755;
    color: white;
    padding: 16px;
    font-size: 24px;
    font-weight: bold;
    text-align: center;
  }

  .container {
    padding: 20px;
    max-width: 560px;
    margin: 0 auto;
  }

  .loading {
    font-size: 18px;
    text-align: center;
    padding: 20px 0;
    color: #666;
  }

  .result-box {
    margin-top: 10px;
    padding: 0;
    border-radius: 12px;
    display: none;
  }

  .record {
    padding: 14px 16px;
    font-size: 16px;
    background: #ffffff;
    border-radius: 12px;
    margin-bottom: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }

  .record:last-child {
    margin-bottom: 0;
  }

  .record-table {
    width: 100%;
    border-collapse: collapse;
  }

  .record-table th {
    text-align: left;
    padding: 4px 6px;
    width: 90px;
    white-space: nowrap;
    vertical-align: top;
    font-weight: 700;
  }

  .record-table td {
    padding: 4px 6px;
    word-break: break-all;
  }

  .status-label {
    font-weight: 700;
    color: #d32f2f;
  }

  .payment-label {
    font-weight: 700;
    color: #1976d2;
  }

  .none {
    color: red;
    font-size: 18px;
    padding: 20px 0;
    text-align: center;
  }

  .error {
    color: #d32f2f;
    font-size: 16px;
    padding: 20px 0;
    text-align: center;
  }
</style>
</head>

<body>

<header>訂房查詢</header>

<div class="container">
  <div id="status" class="loading">系統正在查詢您的訂房紀錄，請稍候…</div>
  <div id="resultBox" class="result-box"></div>
</div>

<script>
// ★ 請改成你現在 Script 的 URL（跟 admin / room-calendar 同一個）
const API_URL =
 "https://script.google.com/macros/s/AKfycbz5HEyUZi1MskWO4LRaEuBUfU03KX_9QxCI4DgcDcI7PwXB8J3tpV6GKZoJoNzuwjb7/exec";

// ★ LIFF ID（與預訂表單同一個專案）
const LIFF_ID = "2008409020-Way8kzM7";

/* 將時間字串轉成「YYYY-MM-DD HH:mm」 */
function formatDateTime(value) {
  if (!value) return "";
  const d = new Date(value);
  if (isNaN(d.getTime())) {
    return String(value);
  }
  const y  = d.getFullYear();
  const m  = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  const hh = String(d.getHours()).padStart(2, "0");
  const mm = String(d.getMinutes()).padStart(2, "0");
  return `${y}-${m}-${dd} ${hh}:${mm}`;
}

/* 只顯示日期 YYYY-MM-DD */
function formatDateOnly(value) {
  if (!value) return "";
  let s = String(value);
  if (s.indexOf("T") >= 0) s = s.split("T")[0];
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const d = new Date(s);
  if (isNaN(d.getTime())) return s;
  const y  = d.getFullYear();
  const m  = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
}

/* 初始化 LIFF 並查詢訂房紀錄 */
document.addEventListener("DOMContentLoaded", () => {
  initLiffAndSearch();
});

async function initLiffAndSearch() {
  const statusEl  = document.getElementById("status");
  const resultBox = document.getElementById("resultBox");

  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isInClient()) {
      statusEl.textContent = "請從 LINE 官方帳號的圖文選單開啟本頁面。";
      statusEl.className = "error";
      return;
    }

    let profile;
    try {
      profile = await liff.getProfile();
    } catch (e) {
      console.error("getProfile 失敗：", e);
      statusEl.textContent = "無法取得使用者資料，請稍後再試。";
      statusEl.className = "error";
      return;
    }

    const uid = profile.userId;
    console.log("UID from LIFF:", uid);

    if (!uid) {
      statusEl.textContent = "無法取得使用者資料，請稍後再試。";
      statusEl.className = "error";
      return;
    }

    statusEl.textContent = "正在讀取您的訂房紀錄…";

    const res = await fetch(API_URL + "?uid=" + encodeURIComponent(uid));
    if (!res.ok) {
      throw new Error("伺服器回應錯誤：" + res.status);
    }

    const data = await res.json();

    statusEl.style.display = "none";
    resultBox.style.display = "block";

    if (!Array.isArray(data) || data.length === 0) {
      resultBox.innerHTML = "<div class='none'>目前查無您的訂房紀錄</div>";
      return;
    }

    let html = "";
    data.forEach(d => {
      const createdText = formatDateTime(d.time);      // 建立時間
      const checkinText = formatDateOnly(d.date);      // 入住日
      const statusText  = d.status  || "待確認";
      const payText     = d.payment || "未收款";

      html += `
        <div class="record">
          <table class="record-table">
            <tbody>
              <tr>
                <th>建立時間</th>
                <td>${createdText}</td>
              </tr>
              <tr>
                <th>姓名</th>
                <td>${d.name || ""}</td>
              </tr>
              <tr>
                <th>手機</th>
                <td>${d.phone || ""}</td>
              </tr>
              <tr>
                <th>入住日</th>
                <td>${checkinText}</td>
              </tr>
              <tr>
                <th>天數</th>
                <td>${d.days || ""} 晚</td>
              </tr>
              <tr>
                <th>大人</th>
                <td>${d.adult || ""}</td>
              </tr>
              <tr>
                <th>小孩</th>
                <td>${d.child || ""}</td>
              </tr>
              <tr>
                <th>寵物</th>
                <td>${d.pet || "（無）"}</td>
              </tr>
              <tr>
                <th>館別</th>
                <td>${d.house || ""}</td>
              </tr>
              <tr>
                <th>狀態</th>
                <td><span class="status-label">${statusText}</span></td>
              </tr>
              <tr>
                <th>收款</th>
                <td><span class="payment-label">${payText}</span></td>
              </tr>
              <tr>
                <th>備註</th>
                <td>${d.note || "（無）"}</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
    });

    resultBox.innerHTML = html;

  } catch (err) {
    console.error("查詢發生錯誤：", err);
    resultBox.style.display = "block";
    resultBox.innerHTML =
      "<div class='error'>系統發生錯誤，請稍後再試，或洽詢管家協助。</div>";
    const statusEl2 = document.getElementById("status");
    statusEl2.style.display = "none";
  }
}
</script>

</body>
</html>

