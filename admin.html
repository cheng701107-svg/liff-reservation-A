<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>é–å¯¬é–å»£ â€” ç®¡ç†å¾Œå°</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    margin: 0;
    background: #f5f5f5;
  }

  header {
    background: #06c755;
    color: #fff;
    padding: 16px;
    font-size: 24px;
    font-weight: 900;
    text-align: center;
  }

  .wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px;
  }

  h2 {
    margin: 16px 0 8px;
    font-size: 20px;
  }

  .section {
    background: #f9f9f9;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
  }

  .search-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .search-row input {
    flex: 1;
    min-width: 200px;
    padding: 10px 12px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }

  .btn {
    padding: 8px 12px;
    font-size: 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    white-space: nowrap;
  }

  .btn-primary {
    background: #06c755;
    color: #fff;
  }

  .btn-primary:hover {
    opacity: 0.9;
  }

  .btn-edit {
    background: #1976d2;
    color: #fff;
  }

  .loading,
  .error {
    font-size: 14px;
    margin-top: 8px;
  }

  .loading { color: #666; }
  .error   { color: #d32f2f; }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
  }

  thead {
    background: #00b33c;
    color: #fff;
  }

  th, td {
    padding: 10px 8px;
    font-size: 14px;
    text-align: center;
    border-bottom: 1px solid #eee;
  }

  th { font-weight: 700; }

  tbody tr:last-child td {
    border-bottom: none;
  }

  .status-select {
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid #f0a0a0;
    color: #d32f2f;
    font-weight: 700;
    background: #fff0f0;
  }

  .payment-select {
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid #999;
    color: #1976d2;
    background: #ffffff;
    font-weight: 600;
  }

  .room-calendar-frame {
    width: 100%;
    border: none;
    border-radius: 12px;
    height: 560px;
    background: #fff;
  }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
  }

  .modal {
    background: #ffffff;
    border-radius: 12px;
    padding: 16px 18px;
    width: 90%;
    max-width: 420px;
    box-sizing: border-box;
  }

  .modal h3 {
    margin: 0 0 12px;
    font-size: 18px;
  }

  .modal .field {
    margin-bottom: 10px;
  }

  .modal label {
    display: block;
    font-size: 14px;
    margin-bottom: 4px;
  }

  .modal input,
  .modal select,
  .modal textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 8px 10px;
    font-size: 14px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  .modal textarea { resize: vertical; }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 12px;
  }

  .btn-cancel {
    background: #e0e0e0;
    color: #333;
  }

  @media (max-width: 768px) {
    th, td {
      font-size: 13px;
      padding: 8px 4px;
    }
  }
</style>
</head>

<body>

<header>é–å¯¬é–å»£ â€” ç®¡ç†å¾Œå°</header>

<div class="wrapper">

  <!-- æœå°‹ -->
  <section class="section">
    <h2>ğŸ” æœå°‹è¨‚æˆ¿è³‡æ–™</h2>
    <div class="search-row">
      <input
        id="keyword"
        type="text"
        placeholder="è¼¸å…¥å§“åã€æ‰‹æ©Ÿã€é¤¨åˆ¥æˆ–å…¥ä½æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰"
      />
      <button class="btn btn-primary" id="btnSearch">æœå°‹</button>
      <button class="btn" id="btnClear">æ¸…é™¤</button>
    </div>
    <div id="bookingsStatus" class="loading">è¼‰å…¥ä¸­â€¦</div>
  </section>

  <!-- è¨‚æˆ¿æ¸…å–® -->
  <section class="section">
    <h2>ğŸ“‹ è¨‚æˆ¿æ¸…å–®</h2>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>å§“å</th>
            <th>æ‰‹æ©Ÿ</th>
            <th>å…¥ä½æ—¥</th>
            <th>é¤¨åˆ¥</th>
            <th>å¤©æ•¸</th>
            <th>å¤§äºº</th>
            <th>å°å­©</th>
            <th>å¯µç‰©</th>
            <th>å‚™è¨»</th>
            <th>ç‹€æ…‹</th>
            <th>æ”¶æ¬¾</th>
            <th>ç®¡ç†</th>
          </tr>
        </thead>
        <tbody id="bookingBody"></tbody>
      </table>
    </div>
  </section>

  <!-- æˆ¿æ³æ—¥æ›† -->
  <section class="section">
    <h2>ğŸ¡ æˆ¿æ³ç®¡ç†</h2>
    <iframe
      src="/room-calendar.html"
      class="room-calendar-frame"
      title="æˆ¿æ³ç®¡ç†æ—¥æ›†"
    ></iframe>
  </section>

</div>

<!-- ä¿®æ”¹è¨‚å–® Modal -->
<div id="editModal" class="modal-overlay">
  <div class="modal">
    <h3>ä¿®æ”¹è¨‚å–®</h3>
    <form id="editForm">
      <div class="field">
        <label>å§“å</label>
        <input type="text" id="editName" required />
      </div>
      <div class="field">
        <label>æ‰‹æ©Ÿï¼ˆ10 ç¢¼ï¼‰</label>
        <input type="tel" id="editPhone" maxlength="10" required />
      </div>
      <div class="field">
        <label>å…¥ä½æ—¥ï¼ˆYYYY-MM-DDï¼‰</label>
        <input type="date" id="editCheckin" required />
      </div>
      <div class="field">
        <label>é¤¨åˆ¥</label>
        <select id="editHouse">
          <option value="Aé¤¨">Aé¤¨</option>
          <option value="Bé¤¨">Bé¤¨</option>
        </select>
      </div>
      <div class="field">
        <label>å¤©æ•¸</label>
        <input type="number" id="editDays" min="1" />
      </div>
      <div class="field">
        <label>å¤§äºº</label>
        <input type="number" id="editAdult" min="1" />
      </div>
      <div class="field">
        <label>å°å­©</label>
        <input type="number" id="editChild" min="0" />
      </div>
      <div class="field">
        <label>å¯µç‰©</label>
        <input type="text" id="editPet" />
      </div>
      <div class="field">
        <label>å‚™è¨»</label>
        <textarea id="editNote" rows="3"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-cancel" id="editCancelBtn">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary">å„²å­˜</button>
      </div>
    </form>
  </div>
</div>

<script>
const API_URL   =
 "https://script.google.com/macros/s/AKfycbz5HEyUZi1MskWO4LRaEuBUfU03KX_9QxCI4DgcDcI7PwXB8J3tpV6GKZoJoNzuwjb7/exec";
const ADMIN_KEY = "admin2025";

let allBookings = [];
let editingBooking = null;

/* ========= å…±ç”¨å·¥å…· ========= */

function normalizeDateString(v) {
  if (!v) return "";
  let s = typeof v === "string" ? v : String(v);
  if (s.indexOf("T") >= 0) s = s.split("T")[0];
  return s.trim();
}

// çµ±ä¸€æˆ YYYY-MM-DD
function formatDateOnly(value) {
  if (!value) return "";

  if (value instanceof Date) {
    const y  = value.getFullYear();
    const m  = String(value.getMonth() + 1).padStart(2, "0");
    const d  = String(value.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  const s = String(value).trim();

  let m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if (m) {
    const y  = m[1];
    const mm = m[2].padStart(2, "0");
    const dd = m[3].padStart(2, "0");
    return `${y}-${mm}-${dd}`;
  }

  m = s.match(/^(\d{4})[\/\.](\d{1,2})[\/\.](\d{1,2})$/);
  if (m) {
    const y  = m[1];
    const mm = m[2].padStart(2, "0");
    const dd = m[3].padStart(2, "0");
    return `${y}-${mm}-${dd}`;
  }

  const d2 = new Date(s);
  if (!isNaN(d2.getTime())) {
    const y2  = d2.getFullYear();
    const m2  = String(d2.getMonth() + 1).padStart(2, "0");
    const dd2 = String(d2.getDate()).padStart(2, "0");
    return `${y2}-${m2}-${dd2}`;
  }

  return s;
}

/* é‡æ–°æ•´ç† iframe æˆ¿æ³æ—¥æ›†ï¼ˆä¸ç”¨ä¾è³´è£¡é¢çš„ JS functionï¼‰ */
function reloadRoomCalendar() {
  const iframe = document.querySelector(".room-calendar-frame");
  if (!iframe) return;
  const baseSrc = iframe.src.split("#")[0].split("?")[0];
  iframe.src = baseSrc + "?t=" + Date.now();  // åŠ æ™‚é–“æˆ³é¿å… cache
}

/* ========= å¾å¾Œç«¯æŠ“å…¨éƒ¨è¨‚å–® ========= */
async function loadBookings() {
  const statusEl = document.getElementById("bookingsStatus");
  statusEl.textContent = "è¼‰å…¥ä¸­â€¦";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "getAll",
        admin_key: ADMIN_KEY
      })
    });

    const data = await res.json();
    allBookings = Array.isArray(data) ? data : [];
    statusEl.textContent = `å…± ${allBookings.length} ç­†è¨‚æˆ¿è³‡æ–™`;

    renderTable();
  } catch (e) {
    console.error(e);
    statusEl.textContent = "è®€å–è¨‚æˆ¿è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
    statusEl.className = "error";
  }
}

/* ========= ç•«è¨‚æˆ¿æ¸…å–® ========= */
function renderTable(keyword = "") {
  const tbody = document.getElementById("bookingBody");
  tbody.innerHTML = "";

  const kw = keyword.trim().toLowerCase();

  const filtered = allBookings.filter(b => {
    if (!kw) return true;
    const fields = [
      b.name, b.phone, b.house, b.date,
      b.note, b.status, b.payment
    ].filter(Boolean).map(x => String(x).toLowerCase());
    return fields.some(x => x.includes(kw));
  });

  filtered.forEach(booking => {
    const tr = document.createElement("tr");
    const dateText = formatDateOnly(booking.date);

    tr.innerHTML = `
      <td>${booking.name  || ""}</td>
      <td>${booking.phone || ""}</td>
      <td>${dateText      || ""}</td>
      <td>${booking.house || ""}</td>
      <td>${booking.days  || ""}</td>
      <td>${booking.adult || ""}</td>
      <td>${booking.child || ""}</td>
      <td>${booking.pet   || ""}</td>
      <td>${booking.note  || ""}</td>
    `;

    /* ==== ç‹€æ…‹æ¬„ä½ï¼ˆæœƒé€£å‹•æˆ¿æ³æ—¥æ›†ï¼‰ ==== */
    const tdStatus = document.createElement("td");
    const statusSel = document.createElement("select");
    statusSel.className = "status-select";
    ["å¾…ç¢ºèª","å·²è¨‚æˆ¿","å·²å…¥ä½","å·²å–æ¶ˆ"].forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      statusSel.appendChild(opt);
    });
    const currentStatus = booking.status || "å¾…ç¢ºèª";
    statusSel.value = currentStatus;

    statusSel.addEventListener("change", async () => {
      const newStatus = statusSel.value;
      const oldStatus = booking.status || "å¾…ç¢ºèª";

      try {
        // 1) æ›´æ–°è¨‚å–®ç‹€æ…‹ï¼ˆBookingsï¼‰
        await updateBookingStatus(booking.id, newStatus);
        booking.status = newStatus;

        // 2) åŒæ­¥æ›´æ–°æˆ¿æ³è¡¨ï¼ˆæˆ¿æ³ç®¡ç† sheetï¼‰
        await updateRoomStatusByStatus(booking, newStatus);

        // 3) é‡æ–°è¼‰å…¥æ—¥æ›†
        reloadRoomCalendar();

      } catch (e) {
        console.error(e);
        alert("æ›´æ–°ç‹€æ…‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        statusSel.value = oldStatus;
      }
    });

    tdStatus.appendChild(statusSel);
    tr.appendChild(tdStatus);

    /* ==== æ”¶æ¬¾æ¬„ä½ ==== */
    const tdPay = document.createElement("td");
    const paySel = document.createElement("select");
    paySel.className = "payment-select";
    ["æœªæ”¶æ¬¾","å·²æ”¶è¨‚é‡‘","å·²æ”¶å°¾æ¬¾"].forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      paySel.appendChild(opt);
    });
    const currentPay = booking.payment || "æœªæ”¶æ¬¾";
    paySel.value = currentPay;

    paySel.addEventListener("change", async () => {
      const newPay = paySel.value;
      const oldPay = booking.payment || "æœªæ”¶æ¬¾";
      try {
        await updateBookingPayment(booking.id, newPay);
        booking.payment = newPay;
      } catch (e) {
        console.error(e);
        alert("æ›´æ–°æ”¶æ¬¾ç‹€æ…‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        paySel.value = oldPay;
      }
    });
    tdPay.appendChild(paySel);
    tr.appendChild(tdPay);

    /* ==== ç®¡ç†ï¼ˆä¿®æ”¹ï¼‰ ==== */
    const tdManage = document.createElement("td");
    const btnEdit = document.createElement("button");
    btnEdit.className = "btn btn-edit";
    btnEdit.textContent = "ä¿®æ”¹";
    btnEdit.addEventListener("click", () => openEditModal(booking));
    tdManage.appendChild(btnEdit);
    tr.appendChild(tdManage);

    tbody.appendChild(tr);
  });
}

/* ========= ç‹€æ…‹ â†’ æˆ¿æ³è¡¨ï¼ˆupdateRoomStatusï¼‰ ========= */
async function updateRoomStatusByStatus(booking, newStatus) {
  const house = booking.house;
  const dateStr = formatDateOnly(booking.date);
  if (!house || !dateStr) return;

  let statusCell = "";
  if (newStatus === "å·²è¨‚æˆ¿" || newStatus === "å·²å…¥ä½") {
    statusCell = "æ»¿";       // æ»¿æˆ¿
  } else if (newStatus === "å¾…ç¢ºèª" || newStatus === "å·²å–æ¶ˆ") {
    statusCell = "";         // æ¸…ç©º â†’ è¦–ç‚ºå¯å”®
  } else {
    return;
  }

  await postUpdateRoomStatus(house, dateStr, statusCell);
}

/* ========= ä¿®æ”¹è¨‚å–®ï¼ˆModalï¼‰ ========= */
function openEditModal(booking) {
  editingBooking = booking;
  document.getElementById("editName").value    = booking.name  || "";
  document.getElementById("editPhone").value   = booking.phone || "";
  document.getElementById("editCheckin").value = formatDateOnly(booking.date);
  document.getElementById("editHouse").value   = booking.house || "Aé¤¨";
  document.getElementById("editDays").value    = booking.days  || 1;
  document.getElementById("editAdult").value   = booking.adult || 1;
  document.getElementById("editChild").value   = booking.child || 0;
  document.getElementById("editPet").value     = booking.pet   || "";
  document.getElementById("editNote").value    = booking.note  || "";

  document.getElementById("editModal").style.display = "flex";
}

function closeEditModal() {
  editingBooking = null;
  document.getElementById("editModal").style.display = "none";
}

document.getElementById("editCancelBtn").addEventListener("click", closeEditModal);

/* å„²å­˜ä¿®æ”¹ï¼šæœ‰æˆ¿æ³ API å°±æ“‹æ»¿æˆ¿ï¼Œæ²’æœ‰å°±ç›´æ¥æ”¾è¡Œï¼ˆä¸å†è·³éŒ¯ï¼‰ */
document.getElementById("editForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!editingBooking) return;

  const newName   = document.getElementById("editName").value.trim();
  let   newPhone  = document.getElementById("editPhone").value.trim();
  const newDate   = document.getElementById("editCheckin").value;
  const newHouse  = document.getElementById("editHouse").value;
  const newDays   = document.getElementById("editDays").value;
  const newAdult  = document.getElementById("editAdult").value;
  const newChild  = document.getElementById("editChild").value;
  const newPet    = document.getElementById("editPet").value;
  const newNote   = document.getElementById("editNote").value;

  newPhone = newPhone.replace(/[^0-9]/g, "");
  if (!/^09\d{8}$/.test(newPhone)) {
    alert("æ‰‹æ©Ÿæ ¼å¼éŒ¯èª¤ï¼Œå¿…é ˆç‚º 09 é–‹é ­ 10 ç¢¼");
    return;
  }

  const newDateStr = normalizeDateString(newDate);
  const oldDateStr = formatDateOnly(editingBooking.date);
  const oldHouse   = editingBooking.house;
  const isSameAsOriginal = (newDateStr === oldDateStr && newHouse === oldHouse);

  // â‘  å…ˆè©¦è‘—ç”¨ getRoomStatus æª¢æŸ¥æ»¿æˆ¿ï¼ˆå¤±æ•—å°±ç•¥éï¼Œä¸å† alert é˜»æ“‹ï¼‰
  try {
    const url = `${API_URL}?action=getRoomStatus&ts=${Date.now()}`;
    const res = await fetch(url);
    if (res.ok) {
      const data = await res.json(); // { "Aé¤¨": [...], "Bé¤¨": [...] }
      const fullDates = (data[newHouse] || []).map(normalizeDateString);
      if (fullDates.includes(newDateStr) && !isSameAsOriginal) {
        alert(`ã€Œ${newHouse}ã€åœ¨ ${newDateStr} å·²æ»¿æˆ¿ï¼Œè«‹æ”¹é¸å…¶ä»–æ—¥æœŸã€‚`);
        return;
      }
    } else {
      console.warn("getRoomStatus HTTP error:", res.status);
    }
  } catch (err) {
    console.warn("æª¢æŸ¥æˆ¿æ³å¤±æ•—ï¼ˆåƒ…è¨˜éŒ„ï¼Œä¸æ“‹å­˜æª”ï¼‰", err);
    // ä¸å† alertï¼Œä¸æ“‹å­˜æª”
  }

  // â‘¡ çœŸæ­£æ›´æ–°è¨‚å–®å…§å®¹
  try {
    await updateBookingFields(editingBooking.id, {
      name:  newName,
      phone: newPhone,
      date:  newDateStr,
      house: newHouse,
      days:  newDays,
      adult: newAdult,
      child: newChild,
      pet:   newPet,
      note:  newNote
    });

    const oldDateForRoom  = formatDateOnly(editingBooking.date);
    const oldHouseForRoom = editingBooking.house;

    editingBooking.name  = newName;
    editingBooking.phone = newPhone;
    editingBooking.date  = newDateStr;
    editingBooking.house = newHouse;
    editingBooking.days  = newDays;
    editingBooking.adult = newAdult;
    editingBooking.child = newChild;
    editingBooking.pet   = newPet;
    editingBooking.note  = newNote;

    // â‘¢ å¦‚æœé€™ç­†ç‹€æ…‹æ˜¯ã€Œå·²è¨‚æˆ¿ / å·²å…¥ä½ã€ï¼Œç­‰æ–¼é€™ä¸€ç­†æœƒåƒæ‰æˆ¿æ³
    if (editingBooking.status === "å·²è¨‚æˆ¿" || editingBooking.status === "å·²å…¥ä½") {
      if (oldDateForRoom && oldHouseForRoom) {
        await postUpdateRoomStatus(oldHouseForRoom, oldDateForRoom, "");
      }
      if (newDateStr && newHouse) {
        await postUpdateRoomStatus(newHouse, newDateStr, "æ»¿");
      }
      reloadRoomCalendar();
    }

    closeEditModal();
    renderTable(document.getElementById("keyword").value);

  } catch (err) {
    console.error(err);
    alert("æ›´æ–°è¨‚å–®è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
  }
});

/* ========= å‘¼å« GASï¼šupdate æ•´ç­†è¨‚å–® ========= */
async function updateBookingFields(id, newData) {
  const payload = {
    action: "update",
    admin_key: ADMIN_KEY,
    id: id,
    name:  newData.name,
    phone: newData.phone,
    house: newData.house,
    date:  newData.date,
    days:  newData.days,
    adult: newData.adult,
    child: newData.child,
    pet:   newData.pet,
    note:  newData.note
  };

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });
  const json = await res.json();
  if (!json.success) {
    throw new Error(json.error || "æ›´æ–°è¨‚å–®è³‡æ–™å¤±æ•—");
  }
}

/* ========= å‘¼å« GASï¼šupdate ç‹€æ…‹ ========= */
async function updateBookingStatus(id, newStatus) {
  const payload = {
    action: "updateStatus",
    admin_key: ADMIN_KEY,
    id: id,
    status: newStatus
  };

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });
  const json = await res.json();
  if (!json.success) {
    throw new Error(json.error || "æ›´æ–°ç‹€æ…‹å¤±æ•—");
  }
}

/* ========= å‘¼å« GASï¼šupdate æ”¶æ¬¾ ========= */
async function updateBookingPayment(id, newPayment) {
  const payload = {
    action: "updatePayment",
    admin_key: ADMIN_KEY,
    id: id,
    payment: newPayment
  };

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });
  const json = await res.json();
  if (!json.success) {
    throw new Error(json.error || "æ›´æ–°æ”¶æ¬¾ç‹€æ…‹å¤±æ•—");
  }
}

/* ========= å‘¼å« GASï¼šç›´æ¥æ›´æ–°æˆ¿æ³è¡¨ ========= */
async function postUpdateRoomStatus(house, dateStr, statusCell) {
  if (!house || !dateStr) return;

  const payload = {
    action: "updateRoomStatus",
    admin_key: ADMIN_KEY,
    house,
    date: dateStr,
    status: statusCell   // "æ»¿" æˆ– ""
  };

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  let json = null;
  try {
    json = await res.json();
  } catch (e) {
    console.warn("updateRoomStatus å›å‚³é JSON", e);
    return;
  }

  if (!json.success) {
    console.error("updateRoomStatus å¤±æ•—ï¼š", json);
  }
}

/* ========= æœå°‹ ========= */
document.getElementById("btnSearch").addEventListener("click", () => {
  const kw = document.getElementById("keyword").value;
  renderTable(kw);
});

document.getElementById("btnClear").addEventListener("click", () => {
  document.getElementById("keyword").value = "";
  renderTable("");
});

/* ========= å•Ÿå‹• ========= */
loadBookings();
</script>

</body>
</html>
