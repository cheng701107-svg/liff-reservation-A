<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>é–å¯¬é–å»£ â€” ç®¡ç†å¾Œå°</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    margin: 0;
    background: #f5f5f5;
  }

  header {
    background: #06c755;
    color: #fff;
    padding: 16px;
    font-size: 24px;
    font-weight: 900;
    text-align: center;
  }

  .wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px;
  }

  h2 {
    margin: 16px 0 8px;
    font-size: 20px;
  }

  .section {
    background: #f9f9f9;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
  }

  /* æœå°‹å€å¡Š */
  .search-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .search-row input {
    flex: 1;
    min-width: 200px;
    padding: 10px 12px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }

  .btn {
    padding: 10px 16px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    white-space: nowrap;
  }

  .btn-primary {
    background: #06c755;
    color: #fff;
  }

  .btn-primary:hover {
    opacity: 0.9;
  }

  .loading,
  .error {
    font-size: 14px;
    margin-top: 8px;
  }

  .loading {
    color: #666;
  }

  .error {
    color: #d32f2f;
  }

  /* è¨‚æˆ¿æ¸…å–® table */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
  }

  thead {
    background: #00b33c;
    color: #fff;
  }

  th,
  td {
    padding: 10px 8px;
    font-size: 14px;
    text-align: center;
    border-bottom: 1px solid #eee;
  }

  th {
    font-weight: 700;
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  /* ç‹€æ…‹é¸å–®ï¼ˆç´…å­—ï¼‰ */
  .status-select {
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid #f0a0a0;
    color: #d32f2f;
    font-weight: 700;
    background: #fff0f0;
  }

  /* æ”¶æ¬¾é¸å–®ï¼ˆè—å­—ï¼‰ */
  .payment-select {
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid #999;
    color: #1976d2;   /* è—è‰²å­— */
    background: #ffffff;
    font-weight: 600;
  }

  /* ç®¡ç†æ¬„ã€Œä¿®æ”¹ã€æŒ‰éˆ• */
  .btn-edit {
    padding: 4px 8px;
    font-size: 13px;
    border-radius: 6px;
    border: 1px solid #999;
    background: #ffffff;
    cursor: pointer;
  }

  .btn-edit:hover {
    background: #f0f0f0;
  }

  /* æˆ¿æ³ç®¡ç† iframe */
  .room-calendar-frame {
    width: 100%;
    border: none;
    border-radius: 12px;
    height: 560px; /* è‹¥ä¸å¤ é«˜å¯å†èª¿æ•´ */
    background: #fff;
  }

  @media (max-width: 768px) {
    th,
    td {
      font-size: 13px;
      padding: 8px 4px;
    }
  }
</style>
</head>

<body>

<header>é–å¯¬é–å»£ â€” ç®¡ç†å¾Œå°</header>

<div class="wrapper">

  <!-- ğŸ” æœå°‹è¨‚æˆ¿è³‡æ–™ -->
  <section class="section">
    <h2>ğŸ” æœå°‹è¨‚æˆ¿è³‡æ–™</h2>
    <div class="search-row">
      <input
        id="keyword"
        type="text"
        placeholder="è¼¸å…¥å§“åã€æ‰‹æ©Ÿã€é¤¨åˆ¥æˆ–å…¥ä½æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰"
      />
      <button class="btn btn-primary" id="btnSearch">æœå°‹</button>
      <button class="btn" id="btnClear">æ¸…é™¤</button>
    </div>
    <div id="bookingsStatus" class="loading">è¼‰å…¥ä¸­â€¦</div>
  </section>

  <!-- ğŸ“‹ è¨‚æˆ¿æ¸…å–® -->
  <section class="section">
    <h2>ğŸ“‹ è¨‚æˆ¿æ¸…å–®</h2>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>å§“å</th>
            <th>æ‰‹æ©Ÿ</th>
            <th>å…¥ä½æ—¥</th>
            <th>é¤¨åˆ¥</th>
            <th>å¤©æ•¸</th>
            <th>å¤§äºº</th>
            <th>å°å­©</th>
            <th>å¯µç‰©</th>
            <th>å‚™è¨»</th>
            <th>ç‹€æ…‹</th>
            <th>æ”¶æ¬¾</th>
            <th>ç®¡ç†</th>
          </tr>
        </thead>
        <tbody id="bookingBody">
          <!-- JS å‹•æ…‹ç”¢ç”Ÿ -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- ğŸ¡ æˆ¿æ³ç®¡ç†ï¼ˆæ—¥æ›†ï¼‰ -->
  <section class="section">
    <h2>ğŸ¡ æˆ¿æ³ç®¡ç†</h2>
    <!-- ç›´æ¥åµŒå…¥ room-calendar.html -->
    <iframe
      src="room-calendar.html"
      class="room-calendar-frame"
      title="æˆ¿æ³ç®¡ç†æ—¥æ›†"
    ></iframe>
  </section>

</div>

<script>
const API_URL   =
 "https://script.google.com/macros/s/AKfycbz5HEyUZi1MskWO4LRaEuBUfU03KX_9QxCI4DgcDcI7PwXB8J3tpV6GKZoJoNzuwjb7/exec";
const ADMIN_KEY = "admin2025";

let allBookings = [];

/* å°‡æ™‚é–“å­—ä¸²è½‰æˆ YYYY-MM-DD */
function formatDateOnly(value) {
  if (!value) return "";
  const d = new Date(value);
  if (isNaN(d.getTime())) return String(value);
  const y  = d.getFullYear();
  const m  = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
}

/* è¼‰å…¥æ‰€æœ‰è¨‚æˆ¿è³‡æ–™ï¼ˆå¾Œç«¯ action: "getAll" å›å‚³é™£åˆ—ï¼‰ */
async function loadBookings() {
  const statusEl = document.getElementById("bookingsStatus");
  statusEl.textContent = "è¼‰å…¥ä¸­â€¦";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "getAll",
        admin_key: ADMIN_KEY
      })
    });

    const data = await res.json();
    allBookings = Array.isArray(data) ? data : [];
    statusEl.textContent = `å…± ${allBookings.length} ç­†è¨‚æˆ¿è³‡æ–™`;

    renderTable();
  } catch (e) {
    console.error(e);
    statusEl.textContent = "è®€å–è¨‚æˆ¿è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
    statusEl.className = "error";
  }
}

/* ä¾é—œéµå­—éæ¿¾ä¸¦ç•«å‡ºè¡¨æ ¼ */
function renderTable(keyword = "") {
  const tbody = document.getElementById("bookingBody");
  tbody.innerHTML = "";

  const kw = keyword.trim().toLowerCase();

  const filtered = allBookings.filter(b => {
    if (!kw) return true;
    const fields = [
      b.name,
      b.phone,
      b.house,
      b.date,
      b.note,
      b.status,
      b.payment
    ]
      .filter(Boolean)
      .map(x => String(x).toLowerCase());
    return fields.some(x => x.includes(kw));
  });

  filtered.forEach(booking => {
    const tr = document.createElement("tr");

    const dateText = formatDateOnly(booking.date);

    tr.innerHTML = `
      <td>${booking.name  || ""}</td>
      <td>${booking.phone || ""}</td>
      <td>${dateText      || ""}</td>
      <td>${booking.house || ""}</td>
      <td>${booking.days  || ""}</td>
      <td>${booking.adult || ""}</td>
      <td>${booking.child || ""}</td>
      <td>${booking.pet   || ""}</td>
      <td>${booking.note  || ""}</td>
    `;

    /* ===== ç‹€æ…‹æ¬„ä½ ===== */
    const tdStatus = document.createElement("td");
    const statusSel = document.createElement("select");
    statusSel.className = "status-select";

    const statusOptions = ["å¾…ç¢ºèª", "å·²è¨‚æˆ¿", "å·²å…¥ä½", "å·²å–æ¶ˆ"];
    statusOptions.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      statusSel.appendChild(opt);
    });

    const currentStatus = booking.status || "å¾…ç¢ºèª";
    statusSel.value = currentStatus;

    statusSel.addEventListener("change", async () => {
      const newStatus = statusSel.value;
      const oldStatus = booking.status || "å¾…ç¢ºèª";

      try {
        // å…ˆæ›´æ–°è¨‚å–®ç‹€æ…‹
        await updateBookingStatus(booking, newStatus);
        booking.status = newStatus;

        // ç‹€æ…‹ â†’ æˆ¿æ³ï¼ˆç”¨ YYYY-MM-DDï¼‰
        const dateForRoom = formatDateOnly(booking.date);

        // å·²è¨‚æˆ¿ / å·²å…¥ä½ â†’ æ»¿
        if (newStatus === "å·²è¨‚æˆ¿" || newStatus === "å·²å…¥ä½") {
          await updateRoomFull(booking.house, dateForRoom, "æ»¿");
        }

        // å¾…ç¢ºèª / å·²å–æ¶ˆ â†’ æ¸…ç©ºï¼ˆæ¢å¾©ç©ºæˆ¿ï¼‰
        if (newStatus === "å¾…ç¢ºèª" || newStatus === "å·²å–æ¶ˆ") {
          await updateRoomFull(booking.house, dateForRoom, "");
        }

      } catch (e) {
        console.error(e);
        alert("æ›´æ–°ç‹€æ…‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        statusSel.value = oldStatus; // é‚„åŸé¸å–®
      }
    });

    tdStatus.appendChild(statusSel);
    tr.appendChild(tdStatus);

    /* ===== æ”¶æ¬¾æ¬„ä½ ===== */
    const tdPay = document.createElement("td");
    const paySel = document.createElement("select");
    paySel.className = "payment-select";

    const payOptions = ["æœªæ”¶æ¬¾", "å·²æ”¶è¨‚é‡‘", "å·²æ”¶å°¾æ¬¾"];
    payOptions.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      paySel.appendChild(opt);
    });

    const currentPay = booking.payment || "æœªæ”¶æ¬¾";
    paySel.value = currentPay;

    paySel.addEventListener("change", async () => {
      const newPay = paySel.value;
      const oldPay = booking.payment || "æœªæ”¶æ¬¾";

      try {
        await updateBookingPayment(booking, newPay);
        booking.payment = newPay;
      } catch (e) {
        console.error(e);
        alert("æ›´æ–°æ”¶æ¬¾ç‹€æ…‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        paySel.value = oldPay;
      }
    });

    tdPay.appendChild(paySel);
    tr.appendChild(tdPay);

    /* ===== ç®¡ç†æ¬„ï¼šä¿®æ”¹æŒ‰éˆ• ===== */
    const tdManage = document.createElement("td");
    const editBtn = document.createElement("button");
    editBtn.textContent = "ä¿®æ”¹";
    editBtn.className = "btn-edit";
    editBtn.addEventListener("click", () => {
      openEditDialog(booking);
    });
    tdManage.appendChild(editBtn);
    tr.appendChild(tdManage);

    tbody.appendChild(tr);
  });
}

/* å°è¦–çª—ä¿®æ”¹ä¸€ç­†è¨‚å–® */
function openEditDialog(booking) {
  // ç”¨ prompt ç°¡å–®å¯¦ä½œé€æ¬„ä¿®æ”¹ï¼ˆæŒ‰å–æ¶ˆå°±ä¸è®Šï¼‰
  const newName  = prompt("å§“å", booking.name || "") ;
  if (newName === null) return;

  const newPhone = prompt("æ‰‹æ©Ÿï¼ˆ10 ç¢¼ï¼‰", booking.phone || "");
  if (newPhone === null) return;

  const newDate  = prompt("å…¥ä½æ—¥ï¼ˆYYYY-MM-DDï¼‰", formatDateOnly(booking.date) || "");
  if (newDate === null) return;

  const newHouse = prompt("é¤¨åˆ¥ï¼ˆä¾‹å¦‚ï¼šAé¤¨ æˆ– Bé¤¨ï¼‰", booking.house || "");
  if (newHouse === null) return;

  const newDays  = prompt("å¤©æ•¸ï¼ˆæ™šæ•¸ï¼‰", booking.days || "");
  if (newDays === null) return;

  const newAdult = prompt("å¤§äººäººæ•¸", booking.adult || "");
  if (newAdult === null) return;

  const newChild = prompt("å°å­©äººæ•¸", booking.child || "");
  if (newChild === null) return;

  const newPet   = prompt("å¯µç‰©ï¼ˆä¾‹ï¼š1éš»å°ç‹—ï¼Œç„¡å‰‡å¡«ç„¡ï¼‰", booking.pet || "");
  if (newPet === null) return;

  const newNote  = prompt("å‚™è¨»", booking.note || "");
  if (newNote === null) return;

  const edited = {
    ...booking,
    name:  newName.trim(),
    phone: newPhone.trim(),
    date:  newDate.trim(),
    house: newHouse.trim(),
    days:  newDays.trim(),
    adult: newAdult.trim(),
    child: newChild.trim(),
    pet:   newPet.trim(),
    note:  newNote.trim()
  };

  updateBookingDetail(booking, edited);
}

/* å‘¼å«å¾Œç«¯æ›´æ–°ã€Œæ•´ç­†è¨‚å–®è³‡æ–™ã€ï¼ˆé™¤äº†ç‹€æ…‹ / æ”¶æ¬¾ï¼‰ */
async function updateBookingDetail(original, edited) {
  try {
    const payload = {
      action: "update",
      admin_key: ADMIN_KEY,
      // ç”¨æ™‚é–“ + æ‰‹æ©Ÿ ç•¶ keyï¼ˆå°æ‡‰ GAS çš„ updateBookingï¼‰
      time:  original.time,
      phone: original.phone,
      // æ›´æ–°æ¬„ä½ï¼ˆå°æ‡‰è©¦ç®—è¡¨ B ~ L æ¬„ï¼‰
      uid:    original.uid   || "",
      email:  original.email || "",
      name:   edited.name    || "",
      phoneNew: edited.phone || "", // ç‚ºé¿å…æ··æ·†ï¼Œä¸‹é¢æœƒè™•ç†
      house:  edited.house   || "",
      date:   edited.date    || "",
      days:   edited.days    || "",
      adult:  edited.adult   || "",
      child:  edited.child   || "",
      pet:    edited.pet     || "",
      note:   edited.note    || ""
    };

    // å¾Œç«¯æ˜¯ç”¨ data.phone ä¾†å¯«å…¥ï¼Œé€™è£¡æŠŠ phoneNew å¡«åˆ° phone
    payload.phone = payload.phoneNew;
    delete payload.phoneNew;

    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    if (!json.success) {
      throw new Error(json.error || "æ›´æ–°è¨‚å–®å¤±æ•—");
    }

    // å‰ç«¯åŒæ­¥æ›´æ–°åŸæœ¬çš„ booking ç‰©ä»¶
    original.name  = payload.name;
    original.phone = payload.phone;
    original.house = payload.house;
    original.date  = payload.date;
    original.days  = payload.days;
    original.adult = payload.adult;
    original.child = payload.child;
    original.pet   = payload.pet;
    original.note  = payload.note;

    // é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼ˆä¿ç•™æœå°‹é—œéµå­—ï¼‰
    const kw = document.getElementById("keyword").value;
    renderTable(kw);

    alert("å·²æ›´æ–°è¨‚å–®è³‡æ–™");

  } catch (e) {
    console.error(e);
    alert("æ›´æ–°è¨‚å–®è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
  }
}

/* å‘¼å«å¾Œç«¯æ›´æ–°ã€Œç‹€æ…‹ã€ */
async function updateBookingStatus(booking, newStatus) {
  const payload = {
    action: "updateStatus",
    admin_key: ADMIN_KEY,
    time:  booking.time,
    phone: booking.phone,
    status: newStatus
  };

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  if (!json.success) {
    throw new Error(json.error || "æ›´æ–°ç‹€æ…‹å¤±æ•—");
  }
}

/* å‘¼å«å¾Œç«¯æ›´æ–°ã€Œæ”¶æ¬¾ã€ç‹€æ…‹ */
async function updateBookingPayment(booking, newPayment) {
  const payload = {
    action: "updatePayment",
    admin_key: ADMIN_KEY,
    time:  booking.time,
    phone: booking.phone,
    payment: newPayment
  };

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  if (!json.success) {
    throw new Error(json.error || "æ›´æ–°æ”¶æ¬¾ç‹€æ…‹å¤±æ•—");
  }
}

/* æ›´æ–°æˆ¿æ³ç®¡ç†è¡¨ï¼ˆè®“ room-calendar.html çœ‹åˆ°ã€Œæ»¿ã€æˆ–ç©ºï¼‰ */
async function updateRoomFull(house, date, status) {
  if (!house || !date) return;

  // ä¸€å¾‹è½‰æˆ YYYY-MM-DDï¼Œè·Ÿæˆ¿æ³è¡¨æ ¼å¼ä¸€è‡´
  const dateStr = formatDateOnly(date);

  const payload = {
    action: "updateRoomStatus",
    admin_key: ADMIN_KEY,
    house,
    date: dateStr,
    status  // "æ»¿" or ""
  };

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  try {
    const json = await res.json();
    if (!json.success) {
      console.error("æ›´æ–°æˆ¿æ³å¤±æ•—", json);
    }
  } catch (e) {
    console.warn("æˆ¿æ³ API å›å‚³é JSONï¼Œç•¥éè§£æ");
  }
}

/* æœå°‹æŒ‰éˆ• */
document.getElementById("btnSearch").addEventListener("click", () => {
  const kw = document.getElementById("keyword").value;
  renderTable(kw);
});

document.getElementById("btnClear").addEventListener("click", () => {
  document.getElementById("keyword").value = "";
  renderTable("");
});

/* å•Ÿå‹• */
loadBookings();
</script>

</body>
</html>
