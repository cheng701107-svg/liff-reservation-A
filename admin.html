<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>Line ç®¡ç†å¾Œå°</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    font-family: "Noto Sans TC","Microsoft JhengHei", sans-serif;
    margin: 0;
    background: #f5f5f5;
  }
  header {
    background: #06c755;
    color: #fff;
    padding: 16px;
    font-size: 24px;
    font-weight: 900;
    text-align: center;
  }
  .wrapper {
    max-width: 1300px;
    margin: 0 auto;
    padding: 16px;
  }

  .section {
    background: #fff;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
  }

  /* æœå°‹åˆ— */
  .search-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .search-row input {
    flex: 1;
    min-width: 200px;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  .btn {
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    border: none;
  }
  .btn-primary { background:#06c755; color:#fff; }

  /* æ’åºç®­é ­ */
  th.sortable { cursor: pointer; position: relative; }
  th.sortable::after {
    content: "â‡…";
    position: absolute;
    right: 6px;
    font-size: 12px;
    opacity: 0.7;
  }

  /* è¡¨æ ¼ */
  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 10px;
  }
  th, td {
    padding: 8px 6px;
    font-size: 14px;
    text-align: center;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
  }
  thead {
    background: #00b33c;
    color: #fff;
  }

  input, select {
    width: 95%;
    padding: 4px;
    border-radius: 5px;
    border: 1px solid #bbb;
  }

  /* ç‹€æ…‹é¡è‰² */
  .status-ok { color:#06c755; font-weight:700; }
  .status-wait { color:#f57c00; font-weight:700; }
  .status-cancel { color:#d32f2f; font-weight:700; }
  .status-hold { color:#9C27B0; font-weight:700; }
  .status-checkout { color:#283593; font-weight:700; }

  /* æ”¶æ¬¾é¡è‰² */
  .pay-none { color:#666; font-weight:700; }
  .pay-deposit { color:#f57c00; font-weight:700; }
  .pay-final { color:#007bff; font-weight:700; }
  .pay-full { color:#2e7d32; font-weight:700; }

  /* æ‰‹æ©Ÿå·¦å³æ»‘å‹• */
  .table-wrapper {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  .table-wrapper table {
    min-width: 1200px;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.45);
    z-index: 9998;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .modal-box {
    background: #fff;
    padding: 18px;
    border-radius: 14px;
    width: 92%;
    max-width: 420px;
  }
  body.modal-open { overflow:hidden; height:100vh; }
</style>

</head>

<body>

<!-- ğŸ” å¾Œå°ç™»å…¥ -->
<div id="loginBox"
     style="position:fixed; left:0; top:0; width:100%; height:100%;
            background:#f5f5f5; display:flex; align-items:center; justify-content:center;">

  <div style="background:white; padding:30px; border-radius:12px;
              width:90%; max-width:380px; box-shadow:0 4px 12px rgba(0,0,0,0.15);">

    <h2 style="margin-top:0; text-align:center;">ç®¡ç†å¾Œå°ç™»å…¥</h2>

    <label style="font-weight:700;">è«‹è¼¸å…¥å¾Œå°å¯†ç¢¼ï¼š</label>
    <input id="adminLoginInput" type="password"
           style="width:100%; padding:10px; margin-top:6px; font-size:16px;
                  border:1px solid #ccc; border-radius:8px;">

    <button onclick="checkAdminLogin()"
            style="margin-top:20px; width:100%; padding:12px;
                   background:#06c755; color:white; border:none;
                   border-radius:8px; font-size:16px;">
      ç™»å…¥
    </button>

    <div id="loginError" style="color:#d32f2f; margin-top:10px; text-align:center;"></div>
  </div>
</div>


<header>ç®¡ç†å¾Œå°</header>

<div class="wrapper">

  <!-- ğŸ” æœå°‹ -->
  <section class="section">
    <h2>ğŸ” æœå°‹è¨‚æˆ¿è³‡æ–™</h2>
    <div class="search-row">
      <input id="keyword" type="text" placeholder="è¼¸å…¥å§“åã€æ‰‹æ©Ÿã€é¤¨åˆ¥ã€å…¥ä½æ—¥æœŸâ€¦" />
      <button class="btn btn-primary" id="btnSearch">æœå°‹</button>
      <button class="btn" id="btnClear">æ¸…é™¤</button>
      <button class="btn btn-primary" id="btnExport">åŒ¯å‡º Excel</button>
    </div>
    <div id="bookingsStatus">è¼‰å…¥ä¸­â€¦</div>
  </section>

  <!-- ğŸ§± ä¸€éµæ¨™æ»¿ -->
  <section class="section">
    <h2>ğŸ“Œ å¿«é€Ÿæ¨™è¨»ã€Œæ»¿æˆ¿ã€</h2>

    <div class="field">
      <label>é¤¨åˆ¥</label>
      <select id="blockHouse">
        <option value="Aé¤¨">Aé¤¨</option>
        <option value="Bé¤¨">Bé¤¨</option>
      </select>
    </div>

    <div class="field">
      <label>æ—¥æœŸ</label>
      <input id="blockDate" type="date" />
    </div>

    <button class="btn btn-primary" id="btnBlock">ğŸš« å°‡è©²æ—¥æ¨™ç¤ºç‚ºæ»¿æˆ¿</button>
    <div id="blockStatus" style="margin-top:8px; color:#333;"></div>
  </section>

  <!-- ğŸ“… æ»¿æˆ¿æœˆæ›† -->
  <section class="section">
    <h2>ğŸ“… æ»¿æˆ¿æœˆæ›†ç¸½è¦½</h2>

    <div style="display:flex; gap:10px; align-items:center;">
      <label>é¤¨åˆ¥ï¼š</label>
      <select id="calHouse">
        <option value="Aé¤¨">Aé¤¨</option>
        <option value="Bé¤¨">Bé¤¨</option>
      </select>

      <button class="btn" id="prevMonth">â† ä¸Šä¸€æœˆ</button>
      <button class="btn" id="nextMonth">ä¸‹ä¸€æœˆ â†’</button>
    </div>

    <h3 id="calTitle" style="margin-top:10px;"></h3>

    <table id="calendarTable" style="margin-top:10px; width:100%; text-align:center;">
    </table>
  </section>

  <!-- ğŸ“‹ è¨‚æˆ¿æ¸…å–® -->
  <section class="section">
    <h2 style="display:flex; justify-content:space-between;">
      <span>ğŸ“‹ è¨‚æˆ¿æ¸…å–®</span>
      <button class="btn btn-primary" onclick="openCreateModal()">â• æ–°å¢è¨‚å–®</button>
    </h2>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th class="sortable" data-field="id">ID</th>
            <th class="sortable" data-field="createdAt">å»ºç«‹</th>
            <th class="sortable" data-field="name">å§“å</th>
            <th class="sortable" data-field="phone">æ‰‹æ©Ÿ</th>
            <th class="sortable" data-field="house">é¤¨åˆ¥</th>
            <th class="sortable" data-field="date">å…¥ä½æ—¥</th>
            <th class="sortable" data-field="nights">å¤©æ•¸</th>
            <th class="sortable" data-field="adult">å¤§äºº</th>
            <th class="sortable" data-field="child">å°å­©</th>
            <th>å¯µç‰©</th>
            <th>å‚™è¨»</th>
            <th class="sortable" data-field="status">ç‹€æ…‹</th>
            <th class="sortable" data-field="payment">æ”¶æ¬¾</th>
            <th>æ›´æ–°</th>
          </tr>
        </thead>
        <tbody id="bookingBody"></tbody>
      </table>
    </div>

  </section>

</div>


<script>
const API_URL = "YOUR_GAS_DEPLOY_URL";   // â† ä½ éœ€è¦å¡«å…¥ GAS ç¶²å€
const ADMIN_KEY = "admin2025";

let allBookings = [];
let sortField = "createdAt";
let sortAsc = false;

/* å¾Œå°ç™»å…¥ */
function checkAdminLogin() {
  const v = adminLoginInput.value.trim();
  if (v === ADMIN_KEY) {
    sessionStorage.setItem("adminLogin","yes");
    loginBox.style.display="none";
    loadBookings();
    loadCalendar();
  } else {
    loginError.textContent="âŒ å¯†ç¢¼éŒ¯èª¤";
  }
}

document.addEventListener("DOMContentLoaded",()=>{
  if (sessionStorage.getItem("adminLogin")==="yes"){
    loginBox.style.display="none";
    loadBookings();
    loadCalendar();
  }
});

/* ============================= */
/*  å¾Œå° APIï¼šè¼‰å…¥å…¨éƒ¨è¨‚æˆ¿        */
/* ============================= */
async function loadBookings(){
  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"getAllBookings", admin_key:ADMIN_KEY})
  });
  const json = await res.json();
  allBookings = json.bookings || [];
  bookingsStatus.textContent=`å…± ${allBookings.length} ç­†`;
  renderTable();
}

/* æ’åº */
function sortBookings(list){
  return list.sort((a,b)=>{
    let v1=a[sortField], v2=b[sortField];
    if(sortField==="createdAt" || sortField==="date"){
      v1=new Date(v1); v2=new Date(v2);
    }
    if(["nights","adult","child"].includes(sortField)){
      v1=Number(v1); v2=Number(v2);
    }
    if(v1<v2) return sortAsc? -1:1;
    if(v1>v2) return sortAsc? 1:-1;
    return 0;
  });
}

/* ç‹€æ…‹æ¨£å¼ */
function statusClass(s){
  s=s||"";
  if(["å·²ç¢ºèª","å·²å…¥ä½","å®Œæˆ"].includes(s)) return "status-ok";
  if(["å¾…ç¢ºèª","è™•ç†ä¸­"].includes(s)) return "status-wait";
  if(["å·²å–æ¶ˆ","å–æ¶ˆ"].includes(s)) return "status-cancel";
  if(["ä¿ç•™ä¸­"].includes(s)) return "status-hold";
  if(["å·²é€€æˆ¿"].includes(s)) return "status-checkout";
  return "status-wait";
}
function payClass(s){
  if(s==="å·²æ”¶å…¨é¡") return "pay-full";
  if(s==="å·²æ”¶å°¾æ¬¾") return "pay-final";
  if(s==="å·²æ”¶è¨‚é‡‘") return "pay-deposit";
  return "pay-none";
}

/* è¡¨æ ¼æ¸²æŸ“ */
function renderTable(keyword=""){
  const kw= keyword.toLowerCase().trim();
  let data = allBookings.filter(b=> !kw || JSON.stringify(b).toLowerCase().includes(kw));
  data = sortBookings(data);

  bookingBody.innerHTML=data.map(b=>`
    <tr>
      <td>${b.id}</td>
      <td>${formatDateTime(b.createdAt)}</td>
      <td>${b.name}</td>
      <td>${b.phone}</td>
      <td>${b.house}</td>
      <td>${b.date}</td>
      <td>${b.nights}</td>
      <td>${b.adult}</td>
      <td>${b.child}</td>
      <td>${b.pet||""}</td>
      <td>${b.note||""}</td>
      <td><span class="${statusClass(b.status)}">${b.status}</span></td>
      <td><span class="${payClass(b.payment)}">${b.payment}</span></td>
      <td><button class="btn btn-primary" onclick='openEdit("${b.id}")'>ä¿®æ”¹</button></td>
    </tr>
  `).join("");
}

function formatDateTime(v){
  const d=new Date(v);
  if(isNaN(d)) return v;
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}
  ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}

/* æœå°‹ */
btnSearch.onclick=()=>renderTable(keyword.value);
btnClear.onclick=()=>{keyword.value=""; renderTable("")};

/* åŒ¯å‡º */
btnExport.onclick=()=>{
  const rows = [
    ["ID","å»ºç«‹","å§“å","æ‰‹æ©Ÿ","é¤¨åˆ¥","å…¥ä½æ—¥","å¤©æ•¸",
     "å¤§äºº","å°å­©","å¯µç‰©","å‚™è¨»","ç‹€æ…‹","æ”¶æ¬¾"],
    ...allBookings.map(b=>[
      b.id,b.createdAt,b.name,b.phone,b.house,b.date,
      b.nights,b.adult,b.child,b.pet,b.note,b.status,b.payment
    ])
  ];
  let csv=rows.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="bookings.csv";
  a.click();
};

/* ============================= */
/* ğŸ“… æœˆæ›†                       */
/* ============================= */

let calYear, calMonth;

document.addEventListener("DOMContentLoaded", ()=>{
  const now=new Date();
  calYear=now.getFullYear();
  calMonth=now.getMonth()+1;

  prevMonth.onclick=()=>{ calMonth--; if(calMonth<=0){calMonth=12; calYear--;} loadCalendar(); };
  nextMonth.onclick=()=>{ calMonth++; if(calMonth>=13){calMonth=1; calYear++;} loadCalendar(); };
  calHouse.onchange=loadCalendar;
});

async function loadCalendar(){
  const house = calHouse.value;
  const res = await fetch(`${API_URL}?action=getCalendar&house=${house}&year=${calYear}&month=${calMonth}`);
  const json = await res.json();
  drawCalendar(json.fullDates||[]);
}

function drawCalendar(fullDates){
  calTitle.textContent=`${calYear} å¹´ ${calMonth} æœˆ`;

  const first = new Date(calYear,calMonth-1,1);
  const days = new Date(calYear,calMonth,0).getDate();
  let html=`<tr><th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr><tr>`;
  let pad=first.getDay();

  for(let i=0;i<pad;i++) html+="<td></td>";

  for(let d=1; d<=days; d++){
    const dateStr=`${calYear}-${String(calMonth).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const isFull=fullDates.includes(dateStr);

    html+=`
      <td onclick="openDayList('${dateStr}')"
          style="padding:8px; cursor:pointer; ${isFull?'background:#f44336;color:#fff;font-weight:700;':''}">
        ${d}
        ${isFull?'<br><small>æ»¿</small>':''}
      </td>
    `;
    if((pad+d)%7===0) html+="</tr><tr>";
  }
  html+="</tr>";
  calendarTable.innerHTML=html;
}

function openDayList(date){
  const list = allBookings.filter(b=>b.date===date);
  alert(`ğŸ“… ${date}\n\n${list.length? list.map(b=>`${b.name} / ${b.phone} / ${b.status}`).join("\n"): "ç•¶å¤©ç„¡è¨‚å–®"}`);
}

/* ============================= */
/* â• æ–°å¢è¨‚å–® Modal             */
/* ============================= */
function openCreateModal(){
  createModal.style.display="flex";
  document.body.classList.add("modal-open");
}
function closeCreateModal(){
  createModal.style.display="none";
  document.body.classList.remove("modal-open");
}

async function createBooking(){
  const payload={
    action:"createBooking",
    admin_key:ADMIN_KEY,
    uid:"ADMIN",
    name:newName.value.trim(),
    phone:newPhone.value.trim(),
    house:newHouse.value,
    date:newDate.value,
    nights:Number(newNights.value),
    adult:Number(newAdult.value),
    child:Number(newChild.value),
    pet:newPet.value.trim(),
    note:newNote.value.trim(),
    status:newStatus.value,
    payment:newPayment.value
  };

  if(!/^09\d{8}$/.test(payload.phone)){
    alert("æ‰‹æ©Ÿæ ¼å¼éŒ¯èª¤");
    return;
  }
  if(!payload.date){
    alert("è«‹é¸æ“‡å…¥ä½æ—¥æœŸ");
    return;
  }

  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  });
  const json = await res.json();

  if(json.success){
    alert("æ–°å¢æˆåŠŸï¼");
    closeCreateModal();
    loadBookings();
  }else alert("æ–°å¢å¤±æ•—ï¼š"+json.error);
}
</script>

<!-- â• æ–°å¢è¨‚å–® Modal -->
<div id="createModal" class="modal-overlay">
  <div class="modal-box">
    <h3>â• æ–°å¢è¨‚å–®</h3>

    <label>å§“å</label><input id="newName">
    <label>æ‰‹æ©Ÿ</label><input id="newPhone">
    <label>é¤¨åˆ¥</label><select id="newHouse"><option>Aé¤¨</option><option>Bé¤¨</option></select>
    <label>å…¥ä½æ—¥æœŸ</label><input id="newDate" type="date">
    <label>ä½å®¿å¤©æ•¸</label><input id="newNights" type="number" value="1" min="1">
    <label>å¤§äºº</label><input id="newAdult" type="number" value="2" min="1">
    <label>å°å­©</label><input id="newChild" type="number" value="0" min="0">
    <label>å¯µç‰©</label><input id="newPet">
    <label>å‚™è¨»</label><textarea id="newNote"></textarea>
    <label>ç‹€æ…‹</label><select id="newStatus">
      <option>å¾…ç¢ºèª</option><option>å·²ç¢ºèª</option>
      <option>ä¿ç•™ä¸­</option><option>å·²å…¥ä½</option><option>å·²å–æ¶ˆ</option>
    </select>
    <label>æ”¶æ¬¾</label><select id="newPayment">
      <option>æœªæ”¶æ¬¾</option><option>å·²æ”¶è¨‚é‡‘</option><option>å·²æ”¶å°¾æ¬¾</option><option>å·²æ”¶å…¨é¡</option>
    </select>

    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="createBooking()">æ–°å¢</button>
    <button class="btn" style="width:100%; margin-top:10px;" onclick="closeCreateModal()">é—œé–‰</button>
  </div>
</div>

</body>
</html>
