<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>é–å¯¬é–å»£ â€” ç®¡ç†å¾Œå°</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    font-family: "Noto Sans TC","Microsoft JhengHei", sans-serif;
    margin: 0;
    background: #f5f5f5;
  }
  header {
    background: #06c755;
    color: #fff;
    padding: 16px;
    font-size: 24px;
    font-weight: 900;
    text-align: center;
  }
  .wrapper {
    max-width: 1300px;
    margin: 0 auto;
    padding: 16px;
  }

  .section {
    background: #fff;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
  }

  /* æœå°‹åˆ— */
  .search-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .search-row input {
    flex: 1;
    min-width: 200px;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  .btn {
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    border: none;
  }
  .btn-primary { background:#06c755; color:#fff; }

  /* æ’åºç®­é ­ */
  th.sortable { cursor: pointer; position: relative; }
  th.sortable::after {
    content: "â‡…";
    position: absolute;
    right: 6px;
    font-size: 12px;
    opacity: 0.7;
  }

  /* è¡¨æ ¼ */
  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 10px;
  }
  th, td {
    padding: 8px 6px;
    font-size: 14px;
    text-align: center;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
  }
  thead {
    background: #00b33c;
    color: #fff;
  }

  input, select {
    width: 95%;
    padding: 4px;
    border-radius: 5px;
    border: 1px solid #bbb;
  }

  /* ç‹€æ…‹é¡è‰² */
  .status-ok { color:#06c755; font-weight:700; }
  .status-wait { color:#f57c00; font-weight:700; }
  .status-cancel { color:#d32f2f; font-weight:700; }
  .status-hold { color:#9C27B0; font-weight:700; }
  .status-checkout { color:#283593; font-weight:700; }

  /* æ”¶æ¬¾é¡è‰² */
  .pay-none { color:#666; font-weight:700; }
  .pay-deposit { color:#f57c00; font-weight:700; }
  .pay-final { color:#007bff; font-weight:700; }
  .pay-full { color:#2e7d32; font-weight:700; }

</style>
</head>

<body>
<header>é–å¯¬é–å»£ â€” ç®¡ç†å¾Œå°</header>

<div class="wrapper">

  <!-- ğŸ” æœå°‹ -->
  <section class="section">
    <h2>ğŸ” æœå°‹è¨‚æˆ¿è³‡æ–™</h2>
    <div class="search-row">
      <input id="keyword" type="text" placeholder="è¼¸å…¥å§“åã€æ‰‹æ©Ÿã€é¤¨åˆ¥ã€å…¥ä½æ—¥æœŸâ€¦" />
      <button class="btn btn-primary" id="btnSearch">æœå°‹</button>
      <button class="btn" id="btnClear">æ¸…é™¤</button>
      <button class="btn btn-primary" id="btnExport">åŒ¯å‡º Excel</button>
    </div>
    <div id="bookingsStatus">è¼‰å…¥ä¸­â€¦</div>
  </section>

  <!-- ğŸ§± ä¸€éµæ¨™æ»¿ -->
  <section class="section">
    <h2>ğŸ“Œ å¿«é€Ÿæ¨™è¨»ã€Œæ»¿æˆ¿ã€</h2>

    <div class="field">
      <label>é¤¨åˆ¥</label>
      <select id="blockHouse">
        <option value="Aé¤¨">Aé¤¨</option>
        <option value="Bé¤¨">Bé¤¨</option>
      </select>
    </div>

    <div class="field">
      <label>æ—¥æœŸ</label>
      <input id="blockDate" type="date" />
    </div>

    <button class="btn btn-primary" id="btnBlock">ğŸš« å°‡è©²æ—¥æ¨™ç¤ºç‚ºæ»¿æˆ¿</button>
    <div id="blockStatus" style="margin-top:8px; color:#333;"></div>
  </section>

  <!-- ============================ -->
<!-- ğŸ“… æ»¿æˆ¿æœˆæ›†ç¸½è¦½ -->
<!-- ============================ -->
<section class="section">
  <h2>ğŸ“… æ»¿æˆ¿æœˆæ›†ç¸½è¦½</h2>

  <div style="display:flex; gap:10px; align-items:center;">
    <label>é¤¨åˆ¥ï¼š</label>
    <select id="calHouse">
      <option value="Aé¤¨">Aé¤¨</option>
      <option value="Bé¤¨">Bé¤¨</option>
    </select>

    <button class="btn" id="prevMonth">â† ä¸Šä¸€æœˆ</button>
    <button class="btn" id="nextMonth">ä¸‹ä¸€æœˆ â†’</button>
  </div>

  <h3 id="calTitle" style="margin-top:10px;"></h3>

  <table id="calendarTable" style="margin-top:10px; width:100%; text-align:center;">
    <!-- JS å¡«å…¥ -->
  </table>
</section>

  <!-- è¡¨æ ¼ -->
  <section class="section">
    <h2>ğŸ“‹ è¨‚æˆ¿æ¸…å–®</h2>

    <div>
      <table>
        <thead>
          <tr>
            <th class="sortable" data-field="id">ID</th>
            <th class="sortable" data-field="createdAt">å»ºç«‹</th>
            <th class="sortable" data-field="name">å§“å</th>
            <th class="sortable" data-field="phone">æ‰‹æ©Ÿ</th>
            <th class="sortable" data-field="house">é¤¨åˆ¥</th>
            <th class="sortable" data-field="date">å…¥ä½æ—¥</th>
            <th class="sortable" data-field="nights">å¤©æ•¸</th>
            <th class="sortable" data-field="adult">å¤§äºº</th>
            <th class="sortable" data-field="child">å°å­©</th>
            <th>å¯µç‰©</th>
            <th>å‚™è¨»</th>
            <th class="sortable" data-field="status">ç‹€æ…‹</th>
            <th class="sortable" data-field="payment">æ”¶æ¬¾</th>
            <th>æ›´æ–°</th>
          </tr>
        </thead>
        <tbody id="bookingBody"></tbody>
      </table>
    </div>

  </section>

<script>
const API_URL =
 "https://script.google.com/macros/s/AKfycbxAhWFD3rLv2O1RSnmEA3EJjXIK5vFKja4IHGtL8EW3q-6ZD77K1Emc_ryFAK1fOZKA/exec";
const ADMIN_KEY = "admin2025";

let allBookings = [];
let sortField = "createdAt";
let sortAsc = false; // é è¨­æœ€æ–°å»ºç«‹åœ¨æœ€ä¸Šæ–¹

/* ============================
    ç‹€æ…‹ / æ”¶æ¬¾ é¡è‰²
   ============================ */
function statusClass(s){
  s = (s||"").trim();
  if(["å·²è¨‚æˆ¿","å·²å…¥ä½","å®Œæˆ","å·²ç¢ºèª"].includes(s)) return "status-ok";
  if(["å¾…ç¢ºèª","è™•ç†ä¸­"].includes(s)) return "status-wait";
  if(["å·²å–æ¶ˆ","å–æ¶ˆ"].includes(s)) return "status-cancel";
  if(["ä¿ç•™ä¸­"].includes(s)) return "status-hold";
  if(["å·²é€€æˆ¿"].includes(s)) return "status-checkout";
  return "status-wait";
}

function payClass(s){
  if(s==="å·²æ”¶å…¨é¡") return "pay-full";
  if(s==="å·²æ”¶å°¾æ¬¾") return "pay-final";
  if(s==="å·²æ”¶è¨‚é‡‘") return "pay-deposit";
  return "pay-none";
}

function formatDateOnly(v){
  const d=new Date(v);
  if(isNaN(d.getTime())) return v;
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

/* ============================
    å¾Œå°è¼‰å…¥å…¨éƒ¨è¨‚å–®
   ============================ */
async function loadBookings(){
  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"getAllBookings", admin_key:ADMIN_KEY})
  });
  const json = await res.json();
  allBookings = json.bookings || [];

  document.getElementById("bookingsStatus").textContent =
    `å…± ${allBookings.length} ç­†`;

  renderTable();
}

/* ============================
    æ’åºåŠŸèƒ½
   ============================ */
function sortBookings(list){
  return list.sort((a,b)=>{
    let v1 = a[sortField];
    let v2 = b[sortField];

    // æ—¥æœŸå­—ä¸² â†’ Date
    if(sortField === "createdAt" || sortField === "date"){
      v1 = new Date(v1);
      v2 = new Date(v2);
    }

    // æ•¸å­—æ¬„
    if(["nights","adult","child"].includes(sortField)){
      v1 = Number(v1);
      v2 = Number(v2);
    }

    if(v1 < v2) return sortAsc ? -1 : 1;
    if(v1 > v2) return sortAsc ? 1 : -1;
    return 0;
  });
}

/* ============================
    æ¸²æŸ“è¡¨æ ¼
   ============================ */
function renderTable(keyword=""){
  const tbody = document.getElementById("bookingBody");
  tbody.innerHTML="";

  const kw = keyword.trim().toLowerCase();
  let data = allBookings.filter(b => !kw || JSON.stringify(b).toLowerCase().includes(kw));

  data = sortBookings(data);

  data.forEach(b=>{
    const tr=document.createElement("tr");
    tr.dataset.id=b.id;

    tr.innerHTML = `
      <td>${b.id}</td>
      <td>${b.createdAt}</td>
      <td>${b.name}</td>
      <td>${b.phone}</td>

      <!-- é¤¨åˆ¥ -->
      <td class="view-${b.id}">${b.house}</td>
      <td class="edit-${b.id}" style="display:none">
        <select data-field="house">
          <option ${b.house=="Aé¤¨"?"selected":""}>Aé¤¨</option>
          <option ${b.house=="Bé¤¨"?"selected":""}>Bé¤¨</option>
          <option ${b.house=="Cé¤¨"?"selected":""}>Cé¤¨</option>
        </select>
      </td>

      <!-- å…¥ä½æ—¥ -->
      <td class="view-${b.id}">${formatDateOnly(b.date)}</td>
      <td class="edit-${b.id}" style="display:none">
        <input type="date" value="${formatDateOnly(b.date)}" data-field="date">
      </td>

      <!-- å¤©æ•¸ -->
      <td class="view-${b.id}">${b.nights}</td>
      <td class="edit-${b.id}" style="display:none">
        <input type="number" min="1" value="${b.nights}" data-field="nights">
      </td>

      <!-- å¤§äºº -->
      <td class="view-${b.id}">${b.adult}</td>
      <td class="edit-${b.id}" style="display:none">
        <input type="number" min="1" value="${b.adult}" data-field="adult">
      </td>

      <!-- å°å­© -->
      <td class="view-${b.id}">${b.child}</td>
      <td class="edit-${b.id}" style="display:none">
        <input type="number" min="0" value="${b.child}" data-field="child">
      </td>

      <!-- å¯µç‰© -->
      <td>${b.pet}</td>

      <!-- å‚™è¨» -->
      <td>${b.note}</td>

      <!-- ç‹€æ…‹ -->
      <td class="view-${b.id}">
        <span class="${statusClass(b.status)}">${b.status}</span>
      </td>
      <td class="edit-${b.id}" style="display:none">
        <select data-field="status">
          <option>å¾…ç¢ºèª</option>
          <option>å·²ç¢ºèª</option>
          <option>å·²å…¥ä½</option>
          <option>å·²å–æ¶ˆ</option>
          <option>ä¿ç•™ä¸­</option>
          <option>å·²é€€æˆ¿</option>
        </select>
      </td>

      <!-- æ”¶æ¬¾ -->
      <td class="view-${b.id}">
        <span class="${payClass(b.payment)}">${b.payment}</span>
      </td>
      <td class="edit-${b.id}" style="display:none">
        <select data-field="payment">
          <option>æœªæ”¶æ¬¾</option>
          <option>å·²æ”¶è¨‚é‡‘</option>
          <option>å·²æ”¶å°¾æ¬¾</option>
          <option>å·²æ”¶å…¨é¡</option>
        </select>
      </td>

      <!-- ä¿®æ”¹æŒ‰éˆ• -->
      <td>
        <button class="btn btn-primary" onclick='toggleEdit("${b.id}", this)'>ä¿®æ”¹</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}
/* ============================
    é»æ¬„ä½è§¸ç™¼æ’åº
   ============================ */
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("th.sortable").forEach(th => {
    th.addEventListener("click", () => {
      const field = th.dataset.field;
      if(sortField === field){
        sortAsc = !sortAsc;
      } else {
        sortField = field;
        sortAsc = true;
      }
      renderTable(document.getElementById("keyword").value);
    });
  });

  // ç¶å®šã€Œå¿«é€Ÿæ¨™æ»¿æˆ¿ã€æŒ‰éˆ•
  document.getElementById("btnBlock").addEventListener("click", blockDateFull);
});

/* ============================
    ä¿®æ”¹æ¨¡å¼ï¼ˆåˆ‡æ›ï¼‰
   ============================ */
function toggleEdit(id, btn){
  const editing = btn.textContent === "å„²å­˜";
  const views = document.querySelectorAll(`.view-${id}`);
  const edits = document.querySelectorAll(`.edit-${id}`);

  if(!editing){
    views.forEach(el=>el.style.display="none");
    edits.forEach(el=>el.style.display="table-cell");
    btn.textContent="å„²å­˜";
  } else {
    updateBooking(id, btn);
  }
}

/* ============================
    æ›´æ–°è¨‚å–®
   ============================ */
async function updateBooking(id, btn){
  const tr = btn.closest("tr");
  const inputs = tr.querySelectorAll(`.edit-${id} [data-field]`);

  const payload = {
    id,
    action:"updateBooking",
    admin_key:ADMIN_KEY
  };

  inputs.forEach(el => {
    payload[el.dataset.field] = el.value;
  });

  btn.textContent = "æ›´æ–°ä¸­â€¦";

  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  });

  const json = await res.json();

  if(json.success){
    Object.assign(allBookings.find(x=>x.id==id), payload);

    btn.textContent = "å®Œæˆ";
    setTimeout(()=>{
      renderTable(document.getElementById("keyword").value);
    },400);

  } else {
    btn.textContent = "ä¿®æ”¹";
    alert("æ›´æ–°å¤±æ•—ï¼š" + json.error);
  }
}

/* ============================
    æœå°‹
   ============================ */
document.getElementById("btnSearch").addEventListener("click",()=>{
  renderTable(document.getElementById("keyword").value);
});

document.getElementById("btnClear").addEventListener("click",()=>{
  document.getElementById("keyword").value = "";
  renderTable("");
});

/* ============================
    åŒ¯å‡º CSV
   ============================ */
document.getElementById("btnExport").addEventListener("click",()=>{

  const rows = [
    ["ID","å»ºç«‹","å§“å","æ‰‹æ©Ÿ","é¤¨åˆ¥","å…¥ä½æ—¥","å¤©æ•¸",
     "å¤§äºº","å°å­©","å¯µç‰©","å‚™è¨»","ç‹€æ…‹","æ”¶æ¬¾"],
    ...allBookings.map(b=>[
      b.id,b.createdAt,b.name,b.phone,b.house,b.date,
      b.nights,b.adult,b.child,b.pet,b.note,b.status,b.payment
    ])
  ];

  let csv = rows.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");

  a.href = URL.createObjectURL(blob);
  a.download = "bookings.csv";
  a.click();
});

/* ============================
    ğŸ§± ä¸€éµæ¨™æ»¿æˆ¿ï¼ˆæ–°å¢å‡è¨‚å–®ï¼‰
   ============================ */
async function blockDateFull(){
  const house = document.getElementById("blockHouse").value;
  const date = document.getElementById("blockDate").value;

  if(!date){
    alert("è«‹é¸æ“‡è¦æ¨™ç¤ºæ»¿æˆ¿çš„æ—¥æœŸ");
    return;
  }

  const payload = {
    action: "createBooking",
    uid: "SYSTEM",
    name: "å¤–éƒ¨è¨‚æˆ¿",
    phone: "0000000000",
    email: "",
    house,
    date,
    nights: 1,
    adult: 0,
    child: 0,
    pet: "",
    note: "ç³»çµ±ï¼šæ¨™ç¤ºæ»¿æˆ¿",
    status: "ä¿ç•™ä¸­",
    payment: "æœªæ”¶æ¬¾"
  };

  document.getElementById("blockStatus").textContent = "æ–°å¢ä¸­â€¦";

  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  });
  const json = await res.json();

  if(json.success){
    document.getElementById("blockStatus").textContent =
      `å·²æ¨™ç¤ºæ»¿æˆ¿ï¼ˆ${date}ï¼‰`;
    loadBookings();
  } else {
    document.getElementById("blockStatus").textContent =
      "æ¨™ç¤ºå¤±æ•—ï¼š" + json.error;
  }
}

  /* ============================
   ğŸ“… æ»¿æˆ¿æœˆæ›†åŠŸèƒ½
   ============================ */

let calYear;
let calMonth;

document.addEventListener("DOMContentLoaded", () => {
  const now = new Date();
  calYear = now.getFullYear();
  calMonth = now.getMonth() + 1;

  document.getElementById("prevMonth").addEventListener("click", () => {
    calMonth--;
    if (calMonth === 0) {
      calMonth = 12;
      calYear--;
    }
    loadCalendar();
  });

  document.getElementById("nextMonth").addEventListener("click", () => {
    calMonth++;
    if (calMonth === 13) {
      calMonth = 1;
      calYear++;
    }
    loadCalendar();
  });

  document.getElementById("calHouse").addEventListener("change", loadCalendar);

  loadCalendar(); // é–‹é å…ˆè¼‰å…¥ä¸€æ¬¡
});

async function loadCalendar() {
  const house = document.getElementById("calHouse").value;

  const res = await fetch(
    `${API_URL}?action=getCalendar&house=${house}&year=${calYear}&month=${calMonth}`
  );
  const json = await res.json();

  const full = json.fullDates || [];

  drawCalendar(full);
}

function drawCalendar(fullDates) {
  const calTitle = document.getElementById("calTitle");
  const table = document.getElementById("calendarTable");

  calTitle.textContent = `${calYear} å¹´ ${calMonth} æœˆ`;

  // å»ºç«‹æ—¥æœŸè³‡è¨Š
  const firstDay = new Date(calYear, calMonth - 1, 1);
  const daysInMonth = new Date(calYear, calMonth, 0).getDate();
  const startWeekDay = firstDay.getDay();

  let html = `
    <tr>
      <th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th>
      <th>å››</th><th>äº”</th><th>å…­</th>
    </tr>
    <tr>
  `;

  let dayCount = 0;

  // å‰é¢ç©ºæ ¼
  for (let i = 0; i < startWeekDay; i++) {
    html += "<td></td>";
    dayCount++;
  }

  // æ—¥æœŸ
  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${calYear}-${String(calMonth).padStart(2, "0")}-${String(d).padStart(2, "0")}`;

    const isFull = fullDates.includes(dateStr);

    html += `<td style="padding:8px; ${isFull ? "background:#f44336;color:#fff;font-weight:700;" : ""}">
      ${d}${isFull ? "<br><small>æ»¿</small>" : ""}
    </td>`;

    dayCount++;

    if (dayCount % 7 === 0) html += "</tr><tr>";
  }

  html += "</tr>";

  table.innerHTML = html;
}

/* ============================
    åˆå§‹åŒ–
   ============================ */
loadBookings();
</script>

</body>
</html>
