<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>é–å¯¬é–å»£ â€” ç®¡ç†å¾Œå°</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
    body {
        font-family: Arial, "Microsoft JhengHei";
        background: #f2f2f2;
        margin: 0;
        padding: 0;
    }

    header {
        background: #06c755;
        color: white;
        padding: 16px;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
    }

    .login-box {
        margin: 60px auto;
        width: 90%;
        max-width: 380px;
        background: #fff;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border-radius: 16px;
        text-align: center;
    }

    .login-box input {
        width: 100%;
        padding: 16px;
        font-size: 20px;
        margin-top: 16px;
        border-radius: 12px;
        border: 1px solid #ccc;
    }

    .login-box button {
        width: 100%;
        padding: 16px;
        font-size: 20px;
        background: #06c755;
        border: none;
        color: #fff;
        border-radius: 12px;
        margin-top: 20px;
        cursor: pointer;
    }

    /* ç®¡ç†ä¸»é  */
    .container {
        padding: 16px;
        display: none;
    }

    .search-box input {
        width: 100%;
        padding: 14px;
        font-size: 18px;
        border-radius: 10px;
        border: 1px solid #ccc;
    }

    .table-wrapper {
        margin-top: 20px;
        overflow-x: auto;
        background: white;
        padding: 10px;
        border-radius: 10px;
    }

    table {
        width: 1400px;
        border-collapse: collapse;
        font-size: 16px;
    }

    th {
        background: #06c755;
        color: white;
        padding: 10px;
    }

    td {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }

    .btn-edit, .btn-delete {
        padding: 6px 12px;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
    }
    .btn-edit { background: #007aff; }
    .btn-delete { background: #ff3b30; }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        left: 0; top: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        width: 90%;
        max-width: 420px;
        background: #fff;
        padding: 20px;
        border-radius: 16px;
    }

    .modal-content input, .modal-content select, .modal-content textarea {
        width: 100%;
        margin-top: 12px;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #ccc;
    }

    .modal-content button {
        width: 100%;
        margin-top: 18px;
        padding: 14px;
        background: #06c755;
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        cursor: pointer;
    }

    .room-box {
        margin-top: 20px;
        background: white;
        padding: 16px;
        border-radius: 14px;
    }

    .room-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
    }

    .room-row select {
        padding: 10px;
        font-size: 16px;
        border-radius: 10px;
    }

</style>
</head>

<body>

<header>é–å¯¬é–å»£ â€” ç®¡ç†å¾Œå°</header>

<!-- ç™»å…¥ç•«é¢ -->
<div id="login" class="login-box">
    <h2>è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼</h2>
    <input type="password" id="adminKey" placeholder="ç®¡ç†å¯†ç¢¼" />
    <button onclick="login()">ç™»å…¥</button>
    <p id="loginError" style="color:red; margin-top:10px;"></p>
</div>

<!-- ä¸»ç•«é¢ -->
<div id="main" class="container">

    <h2>ğŸ” æœå°‹è¨‚æˆ¿è³‡æ–™</h2>
    <div class="search-box">
        <input id="searchInput" placeholder="è¼¸å…¥å§“åã€æ‰‹æ©Ÿã€é¤¨åˆ¥æˆ–æ—¥æœŸ" oninput="renderTable()" />
    </div>

    <h2 style="margin-top:30px;">ğŸ“˜ è¨‚æˆ¿æ¸…å–®</h2>

    <div class="table-wrapper">
        <table id="bookingTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>å§“å</th>
                    <th>æ‰‹æ©Ÿ</th>
                    <th>å…¥ä½æ—¥</th>
                    <th>å¤©æ•¸</th>
                    <th>å¤§äºº</th>
                    <th>å°å­©</th>
                    <th>å¯µç‰©</th>
                    <th>é¤¨åˆ¥</th>
                    <th>å‚™è¨»</th>
                    <th>ç®¡ç†</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <h2 style="margin-top:40px;">ğŸ¡ æˆ¿æ³ç®¡ç†</h2>
    <div class="room-box" id="roomStatusBox">
        <!-- æˆ¿æ³å°‡è‡ªå‹•è¼‰å…¥ -->
    </div>
</div>

<!-- ç·¨è¼¯å½ˆçª— -->
<div id="editModal" class="modal">
    <div class="modal-content">

        <h3>ç·¨è¼¯è¨‚å–®</h3>

        <input id="edit_id" type="hidden">

        <label>å§“å</label>
        <input id="edit_name">

        <label>æ‰‹æ©Ÿ</label>
        <input id="edit_phone">

        <label>å…¥ä½æ—¥æœŸ</label>
        <input id="edit_date" type="date">

        <label>å¤©æ•¸</label>
        <input id="edit_days" type="number">

        <label>å¤§äºº</label>
        <input id="edit_adult" type="number">

        <label>å°å­©</label>
        <input id="edit_child" type="number">

        <label>å¯µç‰©</label>
        <select id="edit_pet">
            <option value="ç„¡">ç„¡</option>
            <option value="æœ‰">æœ‰</option>
        </select>

        <label>é¤¨åˆ¥</label>
        <select id="edit_house">
            <option value="Aé¤¨">Aé¤¨</option>
            <option value="Bé¤¨">Bé¤¨</option>
        </select>

        <label>å‚™è¨»</label>
        <textarea id="edit_note"></textarea>

        <button onclick="saveEdit()">å„²å­˜</button>
        <button onclick="closeModal()" style="background:#999;">å–æ¶ˆ</button>

    </div>
</div>

<script>
/* â˜…â˜…â˜…â˜…â˜… è«‹ä¿®æ”¹ç‚ºä½ çš„ GAS API â˜…â˜…â˜…â˜…â˜… */
const API_URL = "https://script.google.com/macros/s/AKfycbz5HEyUZi1MskWO4LRaEuBUfU03KX_9QxCI4DgcDcI7PwXB8J3tpV6GKZoJoNzuwjb7/exec";

let ALL_BOOKINGS = [];
let ADMIN_LOGGED = false;

/* ------------------------------
   ç™»å…¥
-------------------------------- */
function login() {
    const key = document.getElementById("adminKey").value;
    if (key !== "admin2025") {
        document.getElementById("loginError").innerText = "å¯†ç¢¼éŒ¯èª¤";
        return;
    }

    ADMIN_LOGGED = true;
    document.getElementById("login").style.display = "none";
    document.getElementById("main").style.display = "block";

    loadAllBookings();
    loadRoomStatus();
}

/* ------------------------------
   è¼‰å…¥æ‰€æœ‰è¨‚å–®
-------------------------------- */
async function loadAllBookings() {
    const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
            action: "getAll",
            admin_key: "admin2025"
        })
    });

    ALL_BOOKINGS = await res.json();
    renderTable();
}

/* ------------------------------
   æ¸²æŸ“è¨‚å–®è¡¨æ ¼
-------------------------------- */
function renderTable() {
    const q = document.getElementById("searchInput").value.trim();
    const tbody = document.querySelector("#bookingTable tbody");
    tbody.innerHTML = "";

    ALL_BOOKINGS.filter(b => {
        return (
            b.name.includes(q) ||
            b.phone.includes(q) ||
            b.house.includes(q) ||
            b.date.includes(q)
        );
    })
    .forEach(b => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${b.id}</td>
            <td>${b.name}</td>
            <td>${b.phone}</td>
            <td>${b.date}</td>
            <td>${b.days}</td>
            <td>${b.adult}</td>
            <td>${b.child}</td>
            <td>${b.pet}</td>
            <td>${b.house}</td>
            <td>${b.note}</td>
            <td>
                <span class="btn-edit" onclick='openEdit(${JSON.stringify(b)})'>ç·¨è¼¯</span>
                <span class="btn-delete" onclick='deleteBooking("${b.id}")'>åˆªé™¤</span>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* ------------------------------
   åˆªé™¤è¨‚å–®
-------------------------------- */
async function deleteBooking(id) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤ï¼Ÿ")) return;

    await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
            action: "delete",
            id,
            admin_key: "admin2025"
        })
    });

    alert("å·²åˆªé™¤");
    loadAllBookings();
}

/* ------------------------------
   ç·¨è¼¯ â€” æ‰“é–‹ Modal
-------------------------------- */
function openEdit(b) {
    document.getElementById("edit_id").value = b.id;
    document.getElementById("edit_name").value = b.name;
    document.getElementById("edit_phone").value = b.phone;
    document.getElementById("edit_date").value = b.date;
    document.getElementById("edit_days").value = b.days;
    document.getElementById("edit_adult").value = b.adult;
    document.getElementById("edit_child").value = b.child;
    document.getElementById("edit_pet").value = b.pet;
    document.getElementById("edit_house").value = b.house;
    document.getElementById("edit_note").value = b.note;

    document.getElementById("editModal").style.display = "flex";
}

function closeModal() {
    document.getElementById("editModal").style.display = "none";
}

/* ------------------------------
   å„²å­˜ç·¨è¼¯
-------------------------------- */
async function saveEdit() {
    const data = {
        action: "update",
        admin_key: "admin2025",
        id: document.getElementById("edit_id").value,
        name: document.getElementById("edit_name").value,
        phone: document.getElementById("edit_phone").value,
        date: document.getElementById("edit_date").value,
        days: document.getElementById("edit_days").value,
        adult: document.getElementById("edit_adult").value,
        child: document.getElementById("edit_child").value,
        pet: document.getElementById("edit_pet").value,
        house: document.getElementById("edit_house").value,
        note: document.getElementById("edit_note").value
    };

    await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data)
    });

    alert("å·²æ›´æ–°");
    closeModal();
    loadAllBookings();
}

/* ------------------------------
   æˆ¿æ³ç®¡ç† â€” è¼‰å…¥
-------------------------------- */
async function loadRoomStatus() {
    const res = await fetch(API_URL + "?action=getRoomStatus");
    const status = await res.json();

    const box = document.getElementById("roomStatusBox");

    box.innerHTML = `
        <div class="room-row">
            <div>Aé¤¨</div>
            <select onchange="updateRoom('Aé¤¨', this.value)">
                <option value="">å¯é è¨‚</option>
                <option value="æ»¿" ${status["Aé¤¨"].includes(today()) ? "selected" : ""}>å·²æ»¿</option>
            </select>
        </div>

        <div class="room-row">
            <div>Bé¤¨</div>
            <select onchange="updateRoom('Bé¤¨', this.value)">
                <option value="">å¯é è¨‚</option>
                <option value="æ»¿" ${status["Bé¤¨"].includes(today()) ? "selected" : ""}>å·²æ»¿</option>
            </select>
        </div>
    `;
}

function today() {
    const d = new Date();
    return d.toISOString().slice(0, 10);
}

/* ------------------------------
   æ›´æ–°æˆ¿æ³
-------------------------------- */
async function updateRoom(house, status) {
    await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
            action: "updateRoomStatus",
            admin_key: "admin2025",
            house,
            date: today(),
            status
        })
    });

    alert(house + " æˆ¿æ³å·²æ›´æ–°ï¼");
}
</script>

</body>
</html>
