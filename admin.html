<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>é–å¯¬é–å»£ â€” ç®¡ç†å¾Œå°ï¼ˆæ¥µç°¡ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    margin: 0;
    background: #f5f5f5;
  }
  header {
    background: #06c755;
    color: #fff;
    padding: 16px;
    font-size: 24px;
    font-weight: 900;
    text-align: center;
  }
  .wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px;
  }
  h2 {
    margin: 16px 0 8px;
    font-size: 20px;
  }
  .section {
    background: #f9f9f9;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
  }
  .search-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .search-row input {
    flex: 1;
    min-width: 200px;
    padding: 10px 12px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  .btn {
    padding: 8px 12px;
    font-size: 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    white-space: nowrap;
  }
  .btn-primary {
    background: #06c755;
    color: #fff;
  }
  .btn-primary:hover {
    opacity: 0.9;
  }
  .loading,
  .error {
    font-size: 14px;
    margin-top: 8px;
  }
  .loading { color: #666; }
  .error   { color: #d32f2f; }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
  }
  thead {
    background: #00b33c;
    color: #fff;
  }
  th, td {
    padding: 10px 8px;
    font-size: 14px;
    text-align: center;
    border-bottom: 1px solid #eee;
  }
  th {
    font-weight: 700;
  }
  tbody tr:last-child td {
    border-bottom: none;
  }
  @media (max-width: 768px) {
    th, td {
      font-size: 13px;
      padding: 8px 4px;
    }
  }
</style>
</head>

<body>
<header>é–å¯¬é–å»£ â€” ç®¡ç†å¾Œå°ï¼ˆæ¥µç°¡ç‰ˆï¼‰</header>

<div class="wrapper">

  <!-- æœå°‹ -->
  <section class="section">
    <h2>ğŸ” æœå°‹è¨‚æˆ¿è³‡æ–™</h2>
    <div class="search-row">
      <input
        id="keyword"
        type="text"
        placeholder="è¼¸å…¥å§“åã€æ‰‹æ©Ÿã€é¤¨åˆ¥æˆ–å…¥ä½æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰"
      />
      <button class="btn btn-primary" id="btnSearch">æœå°‹</button>
      <button class="btn" id="btnClear">æ¸…é™¤</button>
    </div>
    <div id="bookingsStatus" class="loading">è¼‰å…¥ä¸­â€¦</div>
  </section>

  <!-- è¨‚æˆ¿æ¸…å–® -->
  <section class="section">
    <h2>ğŸ“‹ è¨‚æˆ¿æ¸…å–®</h2>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>å»ºç«‹æ™‚é–“</th>
            <th>å§“å</th>
            <th>æ‰‹æ©Ÿ</th>
            <th>é¤¨åˆ¥</th>
            <th>å…¥ä½æ—¥</th>
            <th>å¤©æ•¸</th>
            <th>å¤§äºº</th>
            <th>å°å­©</th>
            <th>å¯µç‰©</th>
            <th>å‚™è¨»</th>
            <th>ç‹€æ…‹</th>
            <th>æ”¶æ¬¾</th>
          </tr>
        </thead>
        <tbody id="bookingBody"></tbody>
      </table>
    </div>
  </section>

</div>

<script>
const API_URL   =
 "https://script.google.com/macros/s/AKfycbz5HEyUZi1MskWO4LRaEuBUfU03KX_9QxCI4DgcDcI7PwXB8J3tpV6GKZoJoNzuwjb7/exec"; // â† ç”¨ä½ ç›®å‰éƒ¨ç½²å¥½çš„ Web App URL
const ADMIN_KEY = "admin2025";

let allBookings = [];

// æ—¥æœŸæ ¼å¼åŒ–
function formatDateOnly(value) {
  if (!value) return "";
  const d = new Date(value);
  if (isNaN(d.getTime())) return String(value);
  const y  = d.getFullYear();
  const m  = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
}

// è®€å–å…¨éƒ¨è¨‚å–®
async function loadBookings() {
  const statusEl = document.getElementById("bookingsStatus");
  statusEl.className = "loading";
  statusEl.textContent = "è¼‰å…¥ä¸­â€¦";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "getAllBookings",
        admin_key: ADMIN_KEY
      })
    });

    const data = await res.json();
    console.log("getAllBookings å›å‚³", data);

    if (!data.success) {
      throw new Error(data.error || "API å›å‚³å¤±æ•—");
    }

    allBookings = Array.isArray(data.bookings) ? data.bookings : [];
    statusEl.className = "loading";
    statusEl.textContent = `å…± ${allBookings.length} ç­†è¨‚æˆ¿è³‡æ–™`;

    renderTable();

  } catch (err) {
    console.error("loadBookings å¤±æ•—", err);
    statusEl.className = "error";
    statusEl.textContent = "è®€å–è¨‚æˆ¿è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
  }
}

// ç¹ªè£½è¡¨æ ¼ + é—œéµå­—éæ¿¾
function renderTable(keyword = "") {
  const tbody = document.getElementById("bookingBody");
  tbody.innerHTML = "";

  const kw = keyword.trim().toLowerCase();

  const filtered = allBookings.filter(b => {
    if (!kw) return true;
    const fields = [
      b.id,
      b.name,
      b.phone,
      b.house,
      b.date,
      b.note,
      b.status,
      b.payment
    ].filter(Boolean).map(x => String(x).toLowerCase());
    return fields.some(x => x.includes(kw));
  });

  filtered.forEach(b => {
    const tr = document.createElement("tr");

    const createdAtStr = b.createdAt
      ? new Date(b.createdAt).toLocaleString("zh-TW")
      : "";

    tr.innerHTML = `
      <td>${b.id || ""}</td>
      <td>${createdAtStr}</td>
      <td>${b.name || ""}</td>
      <td>${b.phone || ""}</td>
      <td>${b.house || ""}</td>
      <td>${formatDateOnly(b.date) || ""}</td>
      <td>${b.nights || ""}</td>
      <td>${b.adult || ""}</td>
      <td>${b.child || ""}</td>
      <td>${b.pet || ""}</td>
      <td>${b.note || ""}</td>
      <td>${b.status || ""}</td>
      <td>${b.payment || ""}</td>
    `;

    tbody.appendChild(tr);
  });
}

// æœå°‹æŒ‰éˆ•
document.getElementById("btnSearch").addEventListener("click", () => {
  const kw = document.getElementById("keyword").value;
  renderTable(kw);
});

// æ¸…é™¤æŒ‰éˆ•
document.getElementById("btnClear").addEventListener("click", () => {
  document.getElementById("keyword").value = "";
  renderTable("");
});

// èµ·å§‹è¼‰å…¥
loadBookings();
</script>

</body>
</html>
