<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>房況管理日曆（業主版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    font-family: "Noto Sans TC", sans-serif;
    padding: 20px;
  }

  h2 { margin: 0 0 10px; }

  .house-switch {
    margin-bottom: 8px;
  }

  .month-nav {
    display: flex;
    justify-content: space-between;
    margin: 10px 0 20px;
    font-size: 22px;
    font-weight: 700;
  }

  .nav-btn {
    cursor: pointer;
    color: #06c755;
  }

  .week-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-weight: 700;
    margin-bottom: 10px;
    font-size: 20px;
  }

  .week-header div:nth-child(1),
  .week-header div:nth-child(7) {
    color: red;
    font-weight: 900;
  }

  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
  }

  .day {
    padding: 12px 4px;
    border-radius: 8px;
    border: 1px solid #ccc;
    text-align: center;
    font-size: 20px;
    position: relative;
    cursor: pointer;
  }

  .weekend {
    background: #ffe5e5 !important;
    color: #b40000 !important;
  }

  .full {
    background: #ffdddd !important;
    color: red !important;
    border: 2px solid red !important;
    font-weight: 900;
  }

  .free {
    background: #77dd77 !important;
    color: white !important;
    font-weight: 900;
  }

  .today {
    border: 3px solid #06c755 !important;
  }

  .disabled {
    background: #e5e5e5 !important;
    color: #999 !important;
    border: 1px solid #ccc !important;
    pointer-events: none;
    opacity: 0.7;
    cursor: default;
  }
</style>
</head>

<body>

<h2>房況管理日曆（業主版）</h2>

<div class="house-switch">
  <label>選擇館別：</label>
  <select id="house">
    <option value="A館">A館</option>
    <option value="B館">B館</option>
  </select>
</div>

<div class="month-nav">
  <div id="prev" class="nav-btn">← 上個月</div>
  <div id="monthLabel"></div>
  <div id="next" class="nav-btn">下個月 →</div>
</div>

<div class="week-header">
  <div>日</div>
  <div>一</div>
  <div>二</div>
  <div>三</div>
  <div>四</div>
  <div>五</div>
  <div>六</div>
</div>

<div id="calendar" class="calendar"></div>

<script>
// ★ 同一支 GAS
const API_URL =
 "https://script.google.com/macros/s/AKfycbz5HEyUZi1MskWO4LRaEuBUfU03KX_9QxCI4DgcDcI7PwXB8J3tpV6GKZoJoNzuwjb7/exec";

const ADMIN_KEY = "admin2025";

// ★ 預設就給一個空的，避免 undefined
let ROOM_CACHE = { "A館": [], "B館": [] };

let currentYear  = new Date().getFullYear();
let currentMonth = new Date().getMonth(); // 0-11

function formatDateOnly(value) {
  if (!value) return "";
  if (value instanceof Date) {
    const y  = value.getFullYear();
    const m  = String(value.getMonth() + 1).padStart(2, "0");
    const d  = String(value.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }
  const d2 = new Date(value);
  if (!isNaN(d2.getTime())) {
    const y2  = d2.getFullYear();
    const m2  = String(d2.getMonth() + 1).padStart(2, "0");
    const dd2 = String(d2.getDate()).padStart(2, "0");
    return `${y2}-${m2}-${dd2}`;
  }
  return String(value).trim();
}

/* 只負責「盡量」抓房況，如果失敗就 log + 繼續用預設空陣列 */
async function fetchRoomStatus() {
  try {
    const url = API_URL + "?action=getRoomStatus&ts=" + Date.now();
    const res = await fetch(url);
    const text = await res.text();
    console.log("getRoomStatus raw:", text);

    try {
      const data = JSON.parse(text);
      if (data && typeof data === "object") {
        ROOM_CACHE = data;
      } else {
        console.warn("getRoomStatus 解析後不是物件，沿用預設 ROOM_CACHE");
      }
    } catch (e) {
      console.warn("getRoomStatus JSON.parse 失敗，沿用預設 ROOM_CACHE", e);
    }
  } catch (err) {
    console.error("fetchRoomStatus 發生錯誤，沿用預設 ROOM_CACHE", err);
  }
}

/* 畫日曆（不依賴 API 一定成功） */
function generateCalendar() {
  const houseSelect = document.getElementById("house");
  if (!houseSelect) return;

  const house = houseSelect.value;
  const fullDatesRaw = ROOM_CACHE[house] || [];
  const fullDates = fullDatesRaw.map(formatDateOnly);

  const cal = document.getElementById("calendar");
  cal.innerHTML = "";

  document.getElementById("monthLabel").textContent =
    `${currentYear} 年 ${currentMonth + 1} 月`;

  const first = new Date(currentYear, currentMonth, 1).getDay();
  const days  = new Date(currentYear, currentMonth + 1, 0).getDate();

  // 補空白
  for (let i = 0; i < first; i++) {
    const blank = document.createElement("div");
    cal.appendChild(blank);
  }

  const today = new Date();
  today.setHours(0,0,0,0);

  for (let d = 1; d <= days; d++) {
    const dateObj = new Date(currentYear, currentMonth, d);
    dateObj.setHours(0,0,0,0);
    const dateStr = formatDateOnly(dateObj);

    const div = document.createElement("div");
    div.classList.add("day");

    const dow = dateObj.getDay();

    // 過去日期 → 灰、不能點
    if (dateObj < today) {
      div.classList.add("disabled");
      div.textContent = d;
      cal.appendChild(div);
      continue;
    }

    if (dow === 0 || dow === 6) {
      div.classList.add("weekend");
    }

    if (dateObj.getTime() === today.getTime()) {
      div.classList.add("today");
    }

    const isFull = fullDates.includes(dateStr);

    if (isFull) {
      div.classList.add("full");
      div.textContent = "滿";
      div.onclick = () => toggleRoom(dateStr, house, false); // 改為空房
    } else {
      div.classList.add("free");
      div.textContent = d;
      div.onclick = () => toggleRoom(dateStr, house, true);  // 改為滿
    }

    cal.appendChild(div);
  }
}

/* 點某天 → 切換滿 / 空，寫入 GAS */
async function toggleRoom(dateStr, house, toFull) {
  const statusValue = toFull ? "滿" : "";

  const payload = {
    action: "updateRoomStatus",
    admin_key: ADMIN_KEY,
    house,
    date: dateStr,
    status: statusValue
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    let json = null;
    try {
      json = await res.json();
    } catch (e) {
      console.warn("updateRoomStatus 回傳非 JSON", e);
      alert("更新房況失敗（回傳非 JSON），請檢查 GAS log。");
      return;
    }

    if (!json.success) {
      alert("更新房況失敗：" + (json.error || "未知錯誤"));
      console.error("updateRoomStatus error:", json);
      return;
    }

    // 更新快取
    const normalizedDate = formatDateOnly(dateStr);
    const list = ROOM_CACHE[house] || [];

    if (toFull) {
      if (!list.some(d => formatDateOnly(d) === normalizedDate)) {
        list.push(normalizedDate);
      }
      ROOM_CACHE[house] = list;
    } else {
      ROOM_CACHE[house] = list.filter(d => formatDateOnly(d) !== normalizedDate);
    }

    generateCalendar();

  } catch (err) {
    console.error(err);
    alert("更新房況失敗，請稍後再試。");
  }
}

/* 提供給 admin.html 呼叫：強制重抓 + 重畫 */
async function loadCalendar(forceReload = false) {
  // 如果 forceReload 為 true，或 ROOM_CACHE 還是預設空，就重抓
  if (forceReload || !ROOM_CACHE || (!ROOM_CACHE["A館"] && !ROOM_CACHE["B館"])) {
    await fetchRoomStatus();
  }
  generateCalendar();
}

// 掛在 window 給父頁面使用（雖然現在 admin 是用重新載入 src）
window.loadCalendar = loadCalendar;

/* 上 / 下個月 */
document.getElementById("prev").onclick = () => {
  currentMonth--;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }
  generateCalendar();
};

document.getElementById("next").onclick = () => {
  currentMonth++;
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  generateCalendar();
};

document.getElementById("house").addEventListener("change", generateCalendar);

/* 啟動（先嘗試抓資料，失敗也會畫出空日曆） */
loadCalendar(true);
</script>

</body>
</html>
