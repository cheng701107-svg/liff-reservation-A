<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>靖寬靖廣 — 線上預訂</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body {
    font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    margin: 0;
    background: #f5f5f5;
  }

  header {
    background: #06c755;
    color: #fff;
    padding: 16px;
    font-size: 22px;
    font-weight: 900;
    text-align: center;
  }

  .container {
    max-width: 560px;
    margin: 0 auto;
    padding: 16px;
  }

  .card {
    background: #ffffff;
    border-radius: 16px;
    padding: 18px 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }

  h2 {
    margin: 0 0 10px;
    font-size: 18px;
  }

  .field {
    margin-bottom: 12px;
  }

  .field label {
    display: block;
    margin-bottom: 4px;
    font-size: 14px;
    font-weight: 700;
  }

  .field small {
    display: block;
    font-size: 12px;
    color: #666;
  }

  input[type="text"],
  input[type="tel"],
  input[type="number"],
  input[type="date"],
  select,
  textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 8px 10px;
    font-size: 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  textarea {
    resize: vertical;
    min-height: 60px;
  }

  .btn-submit {
    width: 100%;
    padding: 12px;
    border-radius: 999px;
    border: none;
    background: #06c755;
    color: #ffffff;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 8px;
  }

  .btn-submit:disabled {
    background: #9e9e9e;
    cursor: not-allowed;
  }

  .hint {
    font-size: 12px;
    color: #666;
    margin-bottom: 8px;
  }

  .availability {
    font-size: 13px;
    margin-top: 4px;
  }

  .availability.ok {
    color: #2e7d32;
  }

  .availability.full {
    color: #d32f2f;
    font-weight: 700;
  }

  .status-line {
    font-size: 13px;
    margin-bottom: 8px;
    color: #666;
  }

  .status-line strong {
    color: #06c755;
  }
</style>
</head>

<body>

<header>靖寬靖廣 — 線上預訂</header>

<div class="container">
  <div class="card">
    <h2>請填寫預訂資訊</h2>
    <div id="statusLine" class="status-line">
      正在連線 LINE 帳號，請稍候…
    </div>

    <form id="bookingForm">
      <!-- 隱藏欄位：LINE UID / email -->
      <input type="hidden" id="uid" />
      <input type="hidden" id="email" />

      <!-- 姓名：預設顯示；若從 LINE 拿到 displayName 就會自動帶入並隱藏 -->
      <div class="field" id="nameField">
        <label for="name">姓名（必填）</label>
        <input type="text" id="name" required />
      </div>

      <div class="field">
        <label for="phone">手機（必填，10 碼）</label>
        <input
          type="tel"
          id="phone"
          maxlength="10"
          placeholder="0912345678"
          required
        />
        <small>請輸入 09 開頭的 10 碼手機號碼</small>
      </div>

      <div class="field">
        <label for="house">館別</label>
        <select id="house">
          <option value="A館">A館</option>
          <option value="B館">B館</option>
        </select>
      </div>

      <div class="field">
        <label for="date">入住日</label>
        <input type="date" id="date" required />
        <div id="availabilityHint" class="availability"></div>
      </div>

      <div class="field">
        <label for="nights">住宿天數</label>
        <input
          type="number"
          id="nights"
          min="1"
          value="1"
          required
        />
        <small>若連續入住多晚，請輸入總晚數（例如住 2 晚就填 2）</small>
      </div>

      <div class="field">
        <label for="adult">大人數量</label>
        <input
          type="number"
          id="adult"
          min="1"
          value="2"
          required
        />
      </div>

      <div class="field">
        <label for="child">小孩數量</label>
        <input
          type="number"
          id="child"
          min="0"
          value="0"
          required
        />
      </div>

      <div class="field">
        <label for="pet">寵物</label>
        <input
          type="text"
          id="pet"
          placeholder="例如：無 / 1 隻狗 / 2 隻貓"
        />
      </div>

      <div class="field">
        <label for="note">其他備註</label>
        <textarea
          id="note"
          placeholder="可以填寫預計抵達時間、特殊需求…"
        ></textarea>
      </div>

      <div class="hint">
        ※ 此表單送出後，管家會再與您確認，狀態為「已訂房」後即完成預訂。
      </div>

      <button type="submit" id="submitBtn" class="btn-submit" disabled>
        送出預訂
      </button>
    </form>
  </div>
</div>

<script>
// ========= 常數 =========
const API_URL =
 "https://script.google.com/macros/s/AKfycbz5HEyUZi1MskWO4LRaEuBUfU03KX_9QxCI4DgcDcI7PwXB8J3tpV6GKZoJoNzuwjb7/exec";
const LIFF_ID = "2008409020-k4Oy7Y0D";

// ========= DOM =========
const statusLine       = document.getElementById("statusLine");
const submitBtn        = document.getElementById("submitBtn");
const availabilityHint = document.getElementById("availabilityHint");
const uidInput         = document.getElementById("uid");
const emailInput       = document.getElementById("email");
const nameInput        = document.getElementById("name");
const nameField        = document.getElementById("nameField");

let currentFullDatesCache = [];

// 把日期轉成 YYYY-MM-DD
function normalizeDateString(v) {
  if (!v) return "";
  let s = typeof v === "string" ? v : String(v);
  if (s.indexOf("T") >= 0) s = s.split("T")[0];
  return s.trim();
}

// 入住日最小值 = 今天
function setMinDate() {
  const today = new Date();
  const y  = today.getFullYear();
  const m  = String(today.getMonth() + 1).padStart(2, "0");
  const d  = String(today.getDate()).padStart(2, "0");
  document.getElementById("date").setAttribute("min", `${y}-${m}-${d}`);
}

// 初始化
document.addEventListener("DOMContentLoaded", () => {
  setMinDate();
  initLiff();
  bindFormEvents();
});

// ===== LIFF 初始化：自動帶入姓名，能取得就把姓名欄位藏起來 =====
async function initLiff() {
  try {
    await liff.init({ liffId: LIFF_ID });

    // 如果不是在 LINE App 裡 & 還沒登入，導去登入
    if (!liff.isInClient() && !liff.isLoggedIn()) {
      statusLine.textContent = "將前往 LINE 登入頁面，登入後會自動回到此預訂畫面…";
      liff.login({ redirectUri: window.location.href });
      return;
    }

    let profile = null;
    try {
      profile = await liff.getProfile();
    } catch (e) {
      console.warn("取得 profile 失敗：", e);
    }

    const userId      = profile?.userId || "";
    const displayName = profile?.displayName || "";

    if (userId) {
      uidInput.value = userId;
    }

    // 從 LINE 帶入姓名並隱藏欄位
    if (displayName) {
      nameInput.value = displayName;
      nameInput.readOnly = true;
      if (nameField) {
        nameField.style.display = "none";
      }
    }

    // 嘗試從 ID Token 拿 email（如果 LIFF 有勾 email 權限）
    try {
      if (typeof liff.getDecodedIDToken === "function") {
        const decoded = liff.getDecodedIDToken();
        if (decoded && decoded.email) {
          emailInput.value = decoded.email;
        }
      }
    } catch (e) {
      console.warn("解析 ID Token 失敗：", e);
    }

    if (userId) {
      if (liff.isInClient()) {
        statusLine.innerHTML =
          `已從 LINE App 開啟，<strong>${displayName || "貴賓"}</strong> 您好，請確認預訂資訊。`;
      } else {
        statusLine.innerHTML =
          `<strong>${displayName || "貴賓"}</strong> 您好，目前在瀏覽器中使用，本次預訂會綁定您的 LINE 帳號。`;
      }
    } else {
      statusLine.textContent =
        "目前無法取得 LINE 帳號，仍可直接填寫預訂（本次不會綁定 LINE）。";
    }

    submitBtn.disabled = false;
  } catch (err) {
    console.error("LIFF 初始化失敗：", err);
    statusLine.textContent =
      "LIFF 初始化失敗，您仍可直接填寫預訂（本次不會綁定 LINE）。";
    submitBtn.disabled = false;
  }
}

// ===== 綁定欄位事件（檢查房況 + 送出）=====
function bindFormEvents() {
  document.getElementById("house").addEventListener("change", checkAvailability);
  document.getElementById("date").addEventListener("change", checkAvailability);
  document.getElementById("nights").addEventListener("input", checkAvailability);

  document.getElementById("bookingForm").addEventListener("submit", onSubmitBooking);
}

// ===== 檢查房況 =====
async function checkAvailability() {
  const house  = document.getElementById("house").value;
  const date   = document.getElementById("date").value;
  const nights = parseInt(document.getElementById("nights").value || "1", 10);

  const dateStr = normalizeDateString(date);

  availabilityHint.textContent = "";
  availabilityHint.className = "availability";
  submitBtn.disabled = false;

  if (!house || !dateStr || isNaN(nights) || nights <= 0) return;

  try {
    const d = new Date(dateStr);
    const year  = d.getFullYear();
    const month = d.getMonth() + 1;

    const url = `${API_URL}?action=getCalendar&house=${encodeURIComponent(
      house
    )}&year=${year}&month=${month}&ts=${Date.now()}`;

    const res = await fetch(url);
    const data = await res.json();

    currentFullDatesCache = (data.fullDates || []).map(normalizeDateString);

    const conflictDates = [];
    for (let i = 0; i < nights; i++) {
      const dt = new Date(dateStr);
      dt.setDate(dt.getDate() + i);
      const y  = dt.getFullYear();
      const m  = String(dt.getMonth() + 1).padStart(2, "0");
      const dd = String(dt.getDate()).padStart(2, "0");
      const s  = `${y}-${m}-${dd}`;
      if (currentFullDatesCache.includes(s)) conflictDates.push(s);
    }

    if (conflictDates.length > 0) {
      availabilityHint.textContent =
        `⚠ 此區間含有已滿房日期：${conflictDates.join("、")}，請改選其他入住日或縮短天數。`;
      availabilityHint.classList.add("full");
      submitBtn.disabled = true;
    } else {
      availabilityHint.textContent = "✅ 此區間目前尚有空房，歡迎預訂。";
      availabilityHint.classList.add("ok");
      submitBtn.disabled = false;
    }
  } catch (err) {
    console.error("檢查房況失敗：", err);
    availabilityHint.textContent =
      "無法即時確認房況，仍可送出，實際以管家回覆為準。";
    availabilityHint.classList.add("full");
  }
}

// ===== 送出預訂 ＋ 使用者自己分享摘要到 LINE =====
async function onSubmitBooking(e) {
  e.preventDefault();

  const name   = (nameInput.value || "").trim();
  let   phone  = document.getElementById("phone").value.trim();
  const house  = document.getElementById("house").value;
  const date   = document.getElementById("date").value;
  const nights = parseInt(document.getElementById("nights").value || "1", 10);
  const adult  = parseInt(document.getElementById("adult").value || "1", 10);
  const child  = parseInt(document.getElementById("child").value || "0", 10);
  const pet    = document.getElementById("pet").value.trim();
  const note   = document.getElementById("note").value.trim();

  const uid    = uidInput.value || "";
  const email  = emailInput.value || "";

  if (!name) {
    alert("姓名取得失敗，請重新整理畫面或手動輸入。");
    nameField.style.display = "block";
    nameInput.readOnly = false;
    return;
  }

  phone = phone.replace(/[^0-9]/g, "");
  if (!/^09\d{8}$/.test(phone)) {
    alert("手機格式錯誤，必須為 09 開頭 10 碼");
    return;
  }

  if (!house) {
    alert("請選擇館別");
    return;
  }

  const dateStr = normalizeDateString(date);
  if (!dateStr) {
    alert("請選擇入住日期");
    return;
  }

  if (!nights || nights <= 0) {
    alert("天數必須大於等於 1");
    return;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = "送出中…";

  // 傳給 GAS 的資料（不再包含 summaryText / flexMessage）
  const payload = {
    action: "createBooking",
    uid:    uid,
    name:   name,
    phone:  phone,
    email:  email,
    house:  house,
    date:   dateStr,
    nights: nights,
    adult:  adult,
    child:  child,
    pet:    pet,
    note:   note
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    console.log("createBooking 回傳", json);

    if (!json.success) {
      throw new Error(json.error || "預訂失敗");
    }

    const bookingId = json.id || "";

    // 組合預訂摘要文字（給 shareTargetPicker 用）
    const summaryText =
`靖寬靖廣 預訂摘要
訂單編號：${bookingId}
姓名：${name}
手機：${phone}
館別：${house}
入住日：${dateStr}
住宿：${nights} 晚
人數：大人 ${adult} 位 / 小孩 ${child} 位
寵物：${pet || "無"}
備註：${note || "無"}

待管家回覆「已訂房」後即完成預訂。`;

    // 優先用 shareTargetPicker，訊息由「使用者自己」發出，不會扣 Bot 額度
    if (liff.isInClient() && liff.isApiAvailable("shareTargetPicker")) {
      try {
        await liff.shareTargetPicker([
          { type: "text", text: summaryText }
        ]);
        alert("已送出預訂！預訂摘要已在 LINE 分享給您，請留存備查。");
      } catch (shareErr) {
        console.error("shareTargetPicker 失敗：", shareErr);
        alert("已送出預訂！若需備份資訊，可截圖此畫面或使用訂房查詢功能。");
      }
    } else {
      alert("已送出預訂！請截圖此畫面或使用訂房查詢功能備份資料。");
    }

    // 清空表單（保留館別）
    const keepHouse = house;
    document.getElementById("bookingForm").reset();
    document.getElementById("house").value = keepHouse;
    availabilityHint.textContent = "";
    availabilityHint.className = "availability";

  } catch (err) {
    console.error(err);
    alert("預訂失敗，請稍後再試或改用 LINE 私訊管家。");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "送出預訂";
  }
}
</script>

</body>
</html>
