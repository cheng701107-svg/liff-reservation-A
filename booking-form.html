// ========= 送出預訂（包含 LINE 圖卡摘要）=====
async function onSubmitBooking(e) {
  e.preventDefault();

  const name   = (nameInput.value || "").trim();
  let   phone  = document.getElementById("phone").value.trim();
  const house  = document.getElementById("house").value;
  const date   = document.getElementById("date").value;
  const nights = parseInt(document.getElementById("nights").value || "1", 10);
  const adult  = parseInt(document.getElementById("adult").value || "1", 10);
  const child  = parseInt(document.getElementById("child").value || "0", 10);
  const pet    = document.getElementById("pet").value.trim();
  const note   = document.getElementById("note").value.trim();

  const uid    = uidInput.value || "";
  const email  = emailInput.value || "";

  phone = phone.replace(/[^0-9]/g, "");
  if (!/^09\d{8}$/.test(phone)) {
    alert("手機格式錯誤，必須為 09 開頭 10 碼");
    return;
  }

  const dateStr = normalizeDateString(date);

  submitBtn.disabled = true;
  submitBtn.textContent = "送出中…";

  // ========= 给 LINE 的 Flex 图卡 =========
  function row(label, value) {
    return {
      type: "box",
      layout: "baseline",
      contents: [
        {
          type: "text",
          text: label,
          flex: 2,
          color: "#999999",
          size: "sm"
        },
        {
          type: "text",
          text: String(value),
          flex: 5,
          color: "#333333",
          size: "sm",
          wrap: true
        }
      ]
    };
  }

  const flexBubble = {
    type: "bubble",
    body: {
      type: "box",
      layout: "vertical",
      spacing: "md",
      contents: [
        {
          type: "text",
          text: "靖寬靖廣 預訂成功",
          weight: "bold",
          size: "lg",
          color: "#06c755"
        },
        { type: "separator", margin: "md" },
        {
          type: "box",
          layout: "vertical",
          spacing: "xs",
          contents: [
            row("姓名", name),
            row("手機", phone),
            row("館別", house),
            row("入住日", dateStr),
            row("天數", nights + " 晚"),
            row("大人/小孩", `${adult} / ${child}`),
            row("寵物", pet || "無"),
            row("備註", note || "無")
          ]
        }
      ]
    }
  };

  // ========= 送到後端 =========
  const payload = {
    action: "createBooking",
    uid: uid,
    name: name,
    phone: phone,
    email: email,
    house: house,
    date: dateStr,
    nights: nights,
    adult: adult,
    child: child,
    pet: pet,
    note: note,
    replyToken: ""  // 用不到但留著
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    const json = await res.json();

    if (!json.success) {
      throw new Error(json.error || "預訂失敗");
    }

    // ========= 在 LINE 裡用 sendMessages 傳 Flex（重點）=========
    if (!liff.isInClient()) {
      alert("預訂成功，但請在 LINE 內開啟此頁才會收到圖卡摘要。");
    } else {
      await liff.sendMessages([
        {
          type: "flex",
          altText: "靖寬靖廣預訂摘要",
          contents: flexBubble
        }
      ]);
    }

    alert("已送出預訂！請留意 LINE 中的預訂摘要訊息。");

    document.getElementById("bookingForm").reset();
    document.getElementById("house").value = house;
    availabilityHint.textContent = "";
    availabilityHint.className = "availability";

  } catch (err) {
    console.error("提交錯誤:", err);
    alert("預訂已送出，但 LINE 圖卡回傳失敗，請確認您是否在 LINE App 中開啟表單。");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "送出預訂";
  }
}
