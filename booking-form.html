<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>靖寬靖廣 — 線上預訂</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body {
    font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    margin: 0;
    background: #f5f5f5;
  }

  header {
    background: #06c755;
    color: #fff;
    padding: 16px;
    font-size: 22px;
    font-weight: 900;
    text-align: center;
  }

  .container {
    max-width: 560px;
    margin: 0 auto;
    padding: 16px;
  }

  .card {
    background: #ffffff;
    border-radius: 16px;
    padding: 18px 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }

  h2 {
    margin: 0 0 10px;
    font-size: 18px;
  }

  .field {
    margin-bottom: 12px;
  }

  .field label {
    display: block;
    margin-bottom: 4px;
    font-size: 14px;
    font-weight: 700;
  }

  .field small {
    display: block;
    font-size: 12px;
    color: #666;
  }

  input[type="text"],
  input[type="tel"],
  input[type="number"],
  input[type="date"],
  select,
  textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 8px 10px;
    font-size: 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  textarea {
    resize: vertical;
    min-height: 60px;
  }

  .btn-submit {
    width: 100%;
    padding: 12px;
    border-radius: 999px;
    border: none;
    background: #06c755;
    color: #ffffff;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 8px;
  }

  .btn-submit:disabled {
    background: #9e9e9e;
    cursor: not-allowed;
  }

  .availability {
    font-size: 13px;
    margin-top: 4px;
  }

  .availability.ok {
    color: #2e7d32;
  }

  .availability.full {
    color: #d32f2f;
    font-weight: 700;
  }

  .status-line {
    font-size: 13px;
    margin-bottom: 8px;
    color: #666;
  }

  .status-line strong {
    color: #06c755;
  }
</style>
</head>

<body>

<header>靖寬靖廣 — 線上預訂</header>

<div class="container">
  <div class="card">
    <h2>請填寫預訂資訊</h2>
    <div id="statusLine" class="status-line">
      正在連線 LINE 帳號，請稍候…
    </div>

    <form id="bookingForm">
      <input type="hidden" id="uid" />
      <input type="hidden" id="email" />

      <div class="field" id="nameField">
        <label for="name">姓名（必填）</label>
        <input type="text" id="name" required />
      </div>

      <div class="field">
        <label for="phone">手機（必填）</label>
        <input type="tel" id="phone" maxlength="10" placeholder="0912345678" required />
      </div>

      <div class="field">
        <label for="house">館別</label>
        <select id="house">
          <option value="A館">A館</option>
          <option value="B館">B館</option>
        </select>
      </div>

      <div class="field">
        <label for="date">入住日</label>
        <input type="date" id="date" required />
        <div id="availabilityHint" class="availability"></div>
      </div>

      <div class="field">
        <label for="nights">住宿天數</label>
        <input type="number" id="nights" min="1" value="1" />
      </div>

      <div class="field">
        <label for="adult">大人數</label>
        <input type="number" id="adult" min="1" value="2" />
      </div>

      <div class="field">
        <label for="child">小孩數</label>
        <input type="number" id="child" min="0" value="0" />
      </div>

      <div class="field">
        <label for="pet">寵物</label>
        <input type="text" id="pet" placeholder="例如：無 / 1 隻狗" />
      </div>

      <div class="field">
        <label for="note">備註</label>
        <textarea id="note"></textarea>
      </div>

      <button type="submit" id="submitBtn" class="btn-submit" disabled>
        送出預訂
      </button>
    </form>
  </div>
</div>

<script>
/* ------------------------------------------------------------
   CONFIG
-------------------------------------------------------------*/
const API_URL = "https://script.google.com/macros/s/AKfycbwyDvx82gKgUUcyP-Ke7KJw1wVA2thbiGjhb0IO1-NbEUO5CqnXaz--SPSKEYUUB5tj/exec";
const LIFF_ID = "2008409020-k4Oy7Y0D";

/* ------------------------------------------------------------
   DOM
-------------------------------------------------------------*/
const statusLine       = document.getElementById("statusLine");
const submitBtn        = document.getElementById("submitBtn");
const availabilityHint = document.getElementById("availabilityHint");
const uidInput         = document.getElementById("uid");
const emailInput       = document.getElementById("email");
const nameInput        = document.getElementById("name");
const nameField        = document.getElementById("nameField");

/* ------------------------------------------------------------
   INIT
-------------------------------------------------------------*/
document.addEventListener("DOMContentLoaded", () => {
  setMinDate();
  initLiff();
  bindEvents();
});

/* ------------------------------------------------------------
   設定入住日的最小日期（今天）
-------------------------------------------------------------*/
function setMinDate() {
  const today = new Date();
  const y = today.getFullYear();
  const m = String(today.getMonth() + 1).padStart(2, "0");
  const d = String(today.getDate()).padStart(2, "0");
  document.getElementById("date").setAttribute("min", `${y}-${m}-${d}`);
}

/* ------------------------------------------------------------
   LIFF 初始化（取用戶資料）
-------------------------------------------------------------*/
async function initLiff() {
  try {
    await liff.init({ liffId: LIFF_ID });

    let profile = null;
    try {
      profile = await liff.getProfile();
    } catch (err) {}

    if (profile) {
      uidInput.value = profile.userId;
      nameInput.value = profile.displayName;
      nameField.style.display = "none"; // 自動隱藏姓名欄位
    }

    // email
    try {
      const decoded = liff.getDecodedIDToken();
      if (decoded.email) emailInput.value = decoded.email;
    } catch (err) {}

    // 顯示登入狀態
    if (liff.isInClient()) {
      statusLine.innerHTML = `已從 LINE 開啟，<strong>${profile?.displayName || "貴賓"}</strong> 您好`;
    } else {
      statusLine.innerHTML = `目前在瀏覽器中開啟，預訂將綁定您的 LINE 帳號。`;
    }

    submitBtn.disabled = false;
  } catch (err) {
    statusLine.textContent = "LIFF 初始化失敗，仍可預訂，但不會自動傳送圖卡。";
    submitBtn.disabled = false;
  }
}

/* ------------------------------------------------------------
   綁定 event
-------------------------------------------------------------*/
function bindEvents() {
  document.getElementById("house").addEventListener("change", checkRoom);
  document.getElementById("date").addEventListener("change", checkRoom);
  document.getElementById("nights").addEventListener("input", checkRoom);
  document.getElementById("bookingForm").addEventListener("submit", onSubmit);
}

/* ------------------------------------------------------------
   查房況
-------------------------------------------------------------*/
async function checkRoom() {
  const house = document.getElementById("house").value;
  const date  = document.getElementById("date").value;
  const nights = parseInt(document.getElementById("nights").value || "1", 10);

  if (!house || !date || nights <= 0) return;

  const d = new Date(date);
  const y = d.getFullYear();
  const m = d.getMonth() + 1;

  try {
    const res = await fetch(`${API_URL}?action=getCalendar&house=${house}&year=${y}&month=${m}`);
    const json = await res.json();

    const fullDates = json.fullDates || [];
    let conflict = false;

    for (let i = 0; i < nights; i++) {
      const dt = new Date(date);
      dt.setDate(dt.getDate() + i);
      const s = dt.toISOString().split("T")[0];
      if (fullDates.includes(s)) conflict = true;
    }

    if (conflict) {
      availabilityHint.textContent = "⚠ 此期間含已滿房日期";
      availabilityHint.className = "availability full";
      submitBtn.disabled = true;
    } else {
      availabilityHint.textContent = "✓ 有空房可預訂";
      availabilityHint.className = "availability ok";
      submitBtn.disabled = false;
    }

  } catch (err) {
    availabilityHint.textContent = "無法確認房況（仍可預訂）";
    availabilityHint.className = "availability full";
  }
}

/* ------------------------------------------------------------
   送出預訂
-------------------------------------------------------------*/
async function onSubmit(e) {
  e.preventDefault();

  const name   = nameInput.value.trim();
  let phone    = document.getElementById("phone").value.trim();
  const house  = document.getElementById("house").value;
  const date   = document.getElementById("date").value;
  const nights = parseInt(document.getElementById("nights").value || "1", 10);
  const adult  = document.getElementById("adult").value;
  const child  = document.getElementById("child").value;
  const pet    = document.getElementById("pet").value.trim();
  const note   = document.getElementById("note").value.trim();
  const uid    = uidInput.value;
  const email  = emailInput.value;

  if (!/^09\d{8}$/.test(phone)) {
    alert("手機格式錯誤（需為 09 開頭共 10 碼）");
    return;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = "送出中…";

  const payload = {
    action: "createBooking",
    uid, name, phone, email, house,
    date, nights, adult, child, pet, note
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    const json = await res.json();

    if (!json.success) {
      throw new Error(json.error || "後端錯誤");
    }

    /* ========= 回傳 LINE Flex 圖卡 ========= */
    if (liff.isInClient()) {
      await liff.sendMessages([
        {
          type: "flex",
          altText: "靖寬靖廣預訂摘要",
          contents: {
            type: "bubble",
            body: {
              type: "box",
              layout: "vertical",
              spacing: "md",
              contents: [
                {
                  type: "text",
                  text: "靖寬靖廣 預訂成功",
                  weight: "bold",
                  size: "lg",
                  color: "#06c755"
                },
                { type: "separator", margin: "md" },
                detail("姓名", name),
                detail("手機", phone),
                detail("館別", house),
                detail("入住", date),
                detail("天數", nights + " 晚"),
                detail("人數", `大人 ${adult} / 小孩 ${child}`),
                detail("寵物", pet || "無"),
                detail("備註", note || "無")
              ]
            }
          }
        }
      ]);
    }

    alert("預訂已送出！請查看 LINE 聊天室的預訂摘要");

    document.getElementById("bookingForm").reset();
    availabilityHint.textContent = "";

  } catch (err) {
    alert("預訂成功，但 LINE 摘要未成功傳送（請確認是否於 LINE App 開啟）");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "送出預訂";
  }
}

function detail(label, value) {
  return {
    type: "box",
    layout: "horizontal",
    contents: [
      { type: "text", text: label, color: "#999", size: "sm", flex: 3 },
      { type: "text", text: value, size: "sm", flex: 5, wrap: true }
    ]
  };
}
</script>

</body>
</html>
