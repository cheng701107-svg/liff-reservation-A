<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>靖寬靖廣 — 線上預訂</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body {
    font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    margin: 0;
    background: #f5f5f5;
  }

  header {
    background: #06c755;
    color: #fff;
    padding: 16px;
    font-size: 22px;
    font-weight: 900;
    text-align: center;
  }

  .container {
    max-width: 560px;
    margin: 0 auto;
    padding: 16px;
  }

  .section {
    background: #ffffff;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }

  h2 {
    margin-top: 0;
    font-size: 18px;
    margin-bottom: 12px;
  }

  .field {
    margin-bottom: 12px;
  }

  label {
    display: block;
    font-size: 14px;
    margin-bottom: 4px;
  }

  input, select, textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 8px 10px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-family: inherit;
  }

  textarea {
    resize: vertical;
  }

  .btn {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    margin-top: 6px;
  }

  .btn-primary {
    background: #06c755;
    color: #fff;
    font-weight: 700;
  }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .msg {
    margin-top: 12px;
    font-size: 14px;
    text-align: center;
  }

  .msg.ok {
    color: #2e7d32;
  }

  .msg.err {
    color: #d32f2f;
  }
</style>
</head>

<body>

<header>靖寬靖廣 — 線上預訂</header>

<div class="container">
  <div class="section">
    <h2>請填寫預訂資料</h2>

    <form id="bookingForm">
      <!-- 這兩個由 LIFF 自動填寫 -->
      <input type="hidden" id="uid" />
      <input type="hidden" id="email" />

      <div class="field">
        <label>姓名（必填）</label>
        <input type="text" id="name" required />
      </div>

      <div class="field">
        <label>手機（必填，09 開頭 10 碼）</label>
        <input type="tel" id="phone" maxlength="10" required placeholder="0912345678" />
      </div>

      <div class="field">
        <label>入住日（必填）</label>
        <input type="date" id="date" required />
      </div>

      <div class="field">
        <label>入住天數</label>
        <input type="number" id="days" min="1" value="1" />
      </div>

      <div class="field">
        <label>館別</label>
        <select id="house">
          <option value="A館">A館</option>
          <option value="B館">B館</option>
        </select>
      </div>

      <div class="field">
        <label>大人</label>
        <input type="number" id="adult" min="1" value="2" />
      </div>

      <div class="field">
        <label>小孩</label>
        <input type="number" id="child" min="0" value="0" />
      </div>

      <div class="field">
        <label>寵物（例如：無 / 1隻狗）</label>
        <input type="text" id="pet" placeholder="無" />
      </div>

      <div class="field">
        <label>備註</label>
        <textarea id="note" rows="3" placeholder="可填寫特殊需求 / 抵達時間等"></textarea>
      </div>

      <button type="submit" class="btn btn-primary" id="btnSubmit">送出預訂</button>
      <div id="msg" class="msg"></div>
    </form>
  </div>
</div>

<script>
// ★ 請改成你現在 Script 的 URL（跟 admin / room-calendar 同一個）
const API_URL =
 "https://script.google.com/macros/s/AKfycbz5HEyUZi1MskWO4LRaEuBUfU03KX_9QxCI4DgcDcI7PwXB8J3tpV6GKZoJoNzuwjb7/exec";

// ★ LIFF ID（請用你實際的）
const LIFF_ID = "2008409020-Way8kzM7";

const ADMIN_KEY = "admin2025";

function showMsg(text, ok = false) {
  const msgEl = document.getElementById("msg");
  msgEl.textContent = text;
  msgEl.className = "msg " + (ok ? "ok" : "err");
}

function setLoading(loading) {
  const btn = document.getElementById("btnSubmit");
  if (loading) {
    btn.disabled = true;
    btn.textContent = "送出中…";
  } else {
    btn.disabled = false;
    btn.textContent = "送出預訂";
  }
}

/* 初始化 LIFF，抓 uid & email */
document.addEventListener("DOMContentLoaded", async () => {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isInClient()) {
      showMsg("請從 LINE 官方帳號的圖文選單開啟本頁面。", false);
      return;
    }

    const profile = await liff.getProfile();
    const uid = profile.userId;
    document.getElementById("uid").value = uid || "";

    const context = liff.getDecodedIDToken();
    const email = context && context.email ? context.email : "";
    document.getElementById("email").value = email;

  } catch (err) {
    console.error(err);
    showMsg("初始化失敗，請稍後再試。", false);
  }
});

/* 表單送出：呼叫 API 新增訂單 */
document.getElementById("bookingForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  setLoading(true);
  showMsg("");

  const uid   = document.getElementById("uid").value;
  const email = document.getElementById("email").value;
  const name  = document.getElementById("name").value.trim();
  let phone   = document.getElementById("phone").value.trim();
  const date  = document.getElementById("date").value;
  const days  = document.getElementById("days").value || 1;
  const house = document.getElementById("house").value;
  const adult = document.getElementById("adult").value || 2;
  const child = document.getElementById("child").value || 0;
  const pet   = document.getElementById("pet").value.trim();
  const note  = document.getElementById("note").value.trim();

  // 手機簡單驗證
  phone = phone.replace(/[^0-9]/g, "");
  if (!/^09\d{8}$/.test(phone)) {
    showMsg("手機格式錯誤，必須為 09 開頭 10 碼。");
    setLoading(false);
    return;
  }
  if (!date) {
    showMsg("請選擇入住日期。");
    setLoading(false);
    return;
  }

  try {
    const payload = {
      action: "add",
      admin_key: ADMIN_KEY,
      uid,
      email,
      name,
      phone,
      house,
      date,
      days,
      adult,
      child,
      pet,
      note,
      status: "待確認",
      payment: "未收款"
    };

    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    if (!json.success) {
      console.error("add 回傳錯誤", json);
      showMsg("預訂失敗：" + (json.error || "請稍後再試。"));
      setLoading(false);
      return;
    }

    showMsg("已成功送出預訂，感謝您！", true);
    // 送出後可選擇清空或關閉 LIFF
    // liff.closeWindow();

  } catch (err) {
    console.error(err);
    showMsg("系統錯誤，請稍後再試。");
  } finally {
    setLoading(false);
  }
});
</script>

</body>
</html>
