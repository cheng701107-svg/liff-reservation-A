<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>靖寬靖廣 — 線上預訂</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body {
    font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    margin: 0;
    background: #f5f5f5;
  }

  header {
    background: #06c755;
    color: #fff;
    padding: 16px;
    font-size: 22px;
    font-weight: 900;
    text-align: center;
  }

  .container {
    max-width: 560px;
    margin: 0 auto;
    padding: 16px;
  }

  .card {
    background: #ffffff;
    border-radius: 16px;
    padding: 18px 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }

  h2 {
    margin: 0 0 10px;
    font-size: 18px;
  }

  .field {
    margin-bottom: 12px;
  }

  .field label {
    display: block;
    margin-bottom: 4px;
    font-size: 14px;
    font-weight: 700;
  }

  .field small {
    display: block;
    font-size: 12px;
    color: #666;
  }

  input[type="text"],
  input[type="tel"],
  input[type="number"],
  input[type="date"],
  select,
  textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 8px 10px;
    font-size: 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  textarea {
    resize: vertical;
    min-height: 60px;
  }

  .btn-submit {
    width: 100%;
    padding: 12px;
    border-radius: 999px;
    border: none;
    background: #06c755;
    color: #ffffff;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 8px;
  }

  .btn-submit:disabled {
    background: #9e9e9e;
    cursor: not-allowed;
  }

  .hint {
    font-size: 12px;
    color: #666;
    margin-bottom: 8px;
  }

  .availability {
    font-size: 13px;
    margin-top: 4px;
  }

  .availability.ok {
    color: #2e7d32;
  }

  .availability.full {
    color: #d32f2f;
    font-weight: 700;
  }

  .status-line {
    font-size: 13px;
    margin-bottom: 8px;
    color: #666;
  }

  .status-line strong {
    color: #06c755;
  }
</style>
</head>

<body>

<header>靖寬靖廣 — 線上預訂</header>

<div class="container">
  <div class="card">
    <h2>請填寫預訂資訊</h2>
    <div id="statusLine" class="status-line">
      系統正在初始化，請稍候…
    </div>

    <form id="bookingForm">
      <!-- 隱藏欄位：LINE UID / email -->
      <input type="hidden" id="uid" />
      <input type="hidden" id="email" />

      <div class="field">
        <label for="name">姓名（必填）</label>
        <input type="text" id="name" required />
      </div>

      <div class="field">
        <label for="phone">手機（必填，10 碼）</label>
        <input
          type="tel"
          id="phone"
          maxlength="10"
          placeholder="0912345678"
          required
        />
        <small>請輸入 09 開頭的 10 碼手機號碼</small>
      </div>

      <div class="field">
        <label for="house">館別</label>
        <select id="house">
          <option value="A館">A館</option>
          <option value="B館">B館</option>
        </select>
      </div>

      <div class="field">
        <label for="date">入住日</label>
        <input type="date" id="date" required />
        <div id="availabilityHint" class="availability"></div>
      </div>

      <div class="field">
        <label for="nights">住宿天數</label>
        <input
          type="number"
          id="nights"
          min="1"
          value="1"
          required
        />
        <small>若連續入住多晚，請輸入總晚數（例如住 2 晚就填 2）</small>
      </div>

      <div class="field">
        <label for="adult">大人數量</label>
        <input
          type="number"
          id="adult"
          min="1"
          value="2"
          required
        />
      </div>

      <div class="field">
        <label for="child">小孩數量</label>
        <input
          type="number"
          id="child"
          min="0"
          value="0"
          required
        />
      </div>

      <div class="field">
        <label for="pet">寵物</label>
        <input
          type="text"
          id="pet"
          placeholder="例如：無 / 1 隻狗 / 2 隻貓"
        />
      </div>

      <div class="field">
        <label for="note">其他備註</label>
        <textarea
          id="note"
          placeholder="可以填寫預計抵達時間、特殊需求…"
        ></textarea>
      </div>

      <div class="hint">
        ※ 此表單送出後，管家會再與您確認，狀態為「已訂房」後即完成預訂。
      </div>

      <button type="submit" id="submitBtn" class="btn-submit" disabled>
        送出預訂
      </button>
    </form>
  </div>
</div>

<script>
// ======== 請依實際情況修改這兩個常數 ========

// ★ 新 Web App URL（如果你沿用原本部署，這串可維持不變）
const API_URL =
 "https://script.google.com/macros/s/AKfycbz5HEyUZi1MskWO4LRaEuBUfU03KX_9QxCI4DgcDcI7PwXB8J3tpV6GKZoJoNzuwjb7/exec";

// ★ 你的 LIFF ID
const LIFF_ID = "2008409020-Way8kzM7";

// ============================================

const statusLine       = document.getElementById("statusLine");
const submitBtn        = document.getElementById("submitBtn");
const availabilityHint = document.getElementById("availabilityHint");

let currentFullDatesCache = []; // 暫存當月滿房日，減少重複查詢

// 把日期字串標準化成 YYYY-MM-DD
function normalizeDateString(v) {
  if (!v) return "";
  let s = typeof v === "string" ? v : String(v);
  if (s.indexOf("T") >= 0) s = s.split("T")[0];
  return s.trim();
}

// 設定入住日最小日期（今天）
function setMinDate() {
  const today = new Date();
  const y  = today.getFullYear();
  const m  = String(today.getMonth() + 1).padStart(2, "0");
  const d  = String(today.getDate()).padStart(2, "0");
  const minStr = `${y}-${m}-${d}`;
  document.getElementById("date").setAttribute("min", minStr);
}

// 初始化 LIFF
document.addEventListener("DOMContentLoaded", () => {
  setMinDate();
  initLiff();
  bindFormEvents();
});

async function initLiff() {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (liff.isInClient()) {
      const profile = await liff.getProfile();
      document.getElementById("uid").value = profile.userId || "";
      statusLine.innerHTML = `已從 LINE 開啟 <br><strong>${profile.displayName}</strong> 您好，請填寫預訂資訊。`;
    } else {
      statusLine.innerHTML = "目前不是從 LINE App 開啟，此預訂將不會綁定 LINE 帳號。";
    }

    submitBtn.disabled = false;
  } catch (err) {
    console.error("LIFF 初始化失敗：", err);
    statusLine.textContent = "LIFF 初始化失敗，仍可嘗試填寫預訂，但將無法綁定 LINE 帳號。";
    submitBtn.disabled = false;
  }
}

/** 綁定欄位事件：館別 / 入住日 / 天數 改變時，先檢查房況 */
function bindFormEvents() {
  document.getElementById("house").addEventListener("change", checkAvailability);
  document.getElementById("date").addEventListener("change", checkAvailability);
  document.getElementById("nights").addEventListener("input", checkAvailability);

  document.getElementById("bookingForm").addEventListener("submit", onSubmitBooking);
}

/** 檢查選擇的館別＋入住日＋天數是否有滿房衝突 */
async function checkAvailability() {
  const house  = document.getElementById("house").value;
  const date   = document.getElementById("date").value;
  const nights = parseInt(document.getElementById("nights").value || "1", 10);

  const dateStr = normalizeDateString(date);

  availabilityHint.textContent = "";
  availabilityHint.className = "availability";
  submitBtn.disabled = false;

  if (!house || !dateStr || isNaN(nights) || nights <= 0) {
    return;
  }

  try {
    const d = new Date(dateStr);
    const year  = d.getFullYear();
    const month = d.getMonth() + 1;

    const url = `${API_URL}?action=getCalendar&house=${encodeURIComponent(house)}&year=${year}&month=${month}&ts=${Date.now()}`;
    const res = await fetch(url);
    const data = await res.json();

    currentFullDatesCache = (data.fullDates || []).map(normalizeDateString);

    // 依前端選的「入住日 + 天數」計算每一天是否有撞到滿房
    const conflictDates = [];
    for (let i = 0; i < nights; i++) {
      const dt = new Date(dateStr);
      dt.setDate(dt.getDate() + i);
      const y  = dt.getFullYear();
      const m  = String(dt.getMonth() + 1).padStart(2, "0");
      const dd = String(dt.getDate()).padStart(2, "0");
      const s  = `${y}-${m}-${dd}`;
      if (currentFullDatesCache.includes(s)) {
        conflictDates.push(s);
      }
    }

    if (conflictDates.length > 0) {
      availabilityHint.textContent =
        `⚠ 此區間含有已滿房日期：${conflictDates.join("、")}，請改選其他入住日或縮短天數。`;
      availabilityHint.classList.add("full");
      submitBtn.disabled = true;
    } else {
      availabilityHint.textContent = "✅ 此區間目前尚有空房，歡迎預訂。";
      availabilityHint.classList.add("ok");
      submitBtn.disabled = false;
    }

  } catch (err) {
    console.error("檢查房況失敗：", err);
    availabilityHint.textContent = "無法確認房況，仍可嘗試送出，實際以管家回覆為準。";
    availabilityHint.classList.add("full");
    // 這裡不強制 disable，交由管家後端判斷
  }
}

/** 送出預訂表單 */
async function onSubmitBooking(e) {
  e.preventDefault();

  const name   = document.getElementById("name").value.trim();
  let   phone  = document.getElementById("phone").value.trim();
  const house  = document.getElementById("house").value;
  const date   = document.getElementById("date").value;
  const nights = parseInt(document.getElementById("nights").value || "1", 10);
  const adult  = parseInt(document.getElementById("adult").value || "1", 10);
  const child  = parseInt(document.getElementById("child").value || "0", 10);
  const pet    = document.getElementById("pet").value.trim();
  const note   = document.getElementById("note").value.trim();

  const uid    = document.getElementById("uid").value || "";
  const email  = document.getElementById("email").value || "";

  if (!name) {
    alert("請輸入姓名");
    return;
  }

  phone = phone.replace(/[^0-9]/g, "");
  if (!/^09\d{8}$/.test(phone)) {
    alert("手機格式錯誤，必須為 09 開頭 10 碼");
    return;
  }

  if (!house) {
    alert("請選擇館別");
    return;
  }

  const dateStr = normalizeDateString(date);
  if (!dateStr) {
    alert("請選擇入住日期");
    return;
  }

  if (!nights || nights <= 0) {
    alert("天數必須大於等於 1");
    return;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = "送出中…";

  // 準備送給 GAS 的 payload（對應 createBooking）
  const payload = {
    action: "createBooking",
    uid:    uid,
    name:   name,
    phone:  phone,
    email:  email,
    house:  house,
    date:   dateStr,
    nights: nights,
    adult:  adult,
    child:  child,
    pet:    pet,
    note:   note
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    console.log("createBooking 回傳", json);

    if (!json.success) {
      throw new Error(json.error || "預訂失敗");
    }

    alert("已送出預訂！管家將盡快與您確認訂房。");

    // 清空表單（保留館別）
    const keepHouse = house;
    document.getElementById("bookingForm").reset();
    document.getElementById("house").value = keepHouse;
    availabilityHint.textContent = "";
    availabilityHint.className = "availability";

  } catch (err) {
    console.error(err);
    alert("預訂失敗，請稍後再試或改用 LINE 私訊管家。");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "送出預訂";
  }
}
</script>

</body>
</html>
